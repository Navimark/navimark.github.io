<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Navimark"><meta name="keywords" content="Xcode,Python,å¼€å‘æŠ€å·§,AppIcon,å·¥ç¨‹é…ç½®,å·¥ç¨‹ç®¡ç†,å·¥ç¨‹è§£æ"><meta name="description" content="éœ€æ±‚ç”±æ¥æ—¥å¸¸å¼€å‘è¿­ä»£ä¸­ï¼Œä¸ºäº†èƒ½è®©éœ€æ±‚èƒ½å¤Ÿè¢«åŠæ—¶éªŒæ”¶ã€è®©é—®é¢˜ &#x2F; bug èƒ½å¾—åˆ°åŠæ—¶éªŒè¯ï¼Œæˆ‘ä»¬ç¼–å†™çš„ä»£ç éœ€è¦æŒç»­åœ°äº¤ä»˜ï¼Œä¸ºæ­¤æˆ‘ä»¬æ­å»ºäº† Jenkins è‡ªåŠ¨å·¥å…·æ¥äº¤ä»˜ç‰ˆæœ¬ã€‚ æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¼šå¯¹åŒä¸€ä¸ª App å¹¶è¡Œå¼€å‘ä¸åŒçš„ç‰ˆæœ¬ï¼Œéšç€ä¸åŒåŠŸèƒ½çš„ä¸åŒç‰ˆæœ¬çš„åŒä¸€ App çš„äº¤ä»˜ï¼ˆå†…éƒ¨æµ‹è¯•ï¼‰ï¼Œäº§å“åŒå­¦å’Œæµ‹è¯•åŒå­¦å¯èƒ½ä¼šæä¸æ¸…æ¥šè‡ªå·±æ‰‹æœºä¸Šå®‰è£…çš„åˆ°åº•æ˜¯å“ªä¸ªç‰ˆæœ¬ã€å¯¹åº”ç€å“ªä¸ªéœ€æ±‚æˆ–é—®é¢˜è¦è¢«éªŒè¯ï¼Œä»–ä»¬å½“ç„¶å¯ä»¥è¿›å…¥ App"><meta property="og:type" content="article"><meta property="og:title" content="ç»™ Xcode å·¥ç¨‹çš„ AppIcon æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯"><meta property="og:url" content="https://navimark.github.io/posts/4b4dbb8b.html"><meta property="og:site_name" content="å­éé±¼"><meta property="og:description" content="éœ€æ±‚ç”±æ¥æ—¥å¸¸å¼€å‘è¿­ä»£ä¸­ï¼Œä¸ºäº†èƒ½è®©éœ€æ±‚èƒ½å¤Ÿè¢«åŠæ—¶éªŒæ”¶ã€è®©é—®é¢˜ &#x2F; bug èƒ½å¾—åˆ°åŠæ—¶éªŒè¯ï¼Œæˆ‘ä»¬ç¼–å†™çš„ä»£ç éœ€è¦æŒç»­åœ°äº¤ä»˜ï¼Œä¸ºæ­¤æˆ‘ä»¬æ­å»ºäº† Jenkins è‡ªåŠ¨å·¥å…·æ¥äº¤ä»˜ç‰ˆæœ¬ã€‚ æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¼šå¯¹åŒä¸€ä¸ª App å¹¶è¡Œå¼€å‘ä¸åŒçš„ç‰ˆæœ¬ï¼Œéšç€ä¸åŒåŠŸèƒ½çš„ä¸åŒç‰ˆæœ¬çš„åŒä¸€ App çš„äº¤ä»˜ï¼ˆå†…éƒ¨æµ‹è¯•ï¼‰ï¼Œäº§å“åŒå­¦å’Œæµ‹è¯•åŒå­¦å¯èƒ½ä¼šæä¸æ¸…æ¥šè‡ªå·±æ‰‹æœºä¸Šå®‰è£…çš„åˆ°åº•æ˜¯å“ªä¸ªç‰ˆæœ¬ã€å¯¹åº”ç€å“ªä¸ªéœ€æ±‚æˆ–é—®é¢˜è¦è¢«éªŒè¯ï¼Œä»–ä»¬å½“ç„¶å¯ä»¥è¿›å…¥ App"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://navimark.github.io/img/PostIndexImg/Older/add-logo-for-ios-project.png"><meta property="article:published_time" content="2020-08-13T10:52:57.000Z"><meta property="article:modified_time" content="2022-02-23T11:00:40.421Z"><meta property="article:author" content="Navimark"><meta property="article:tag" content="å·¥å…·"><meta property="article:tag" content="iOS"><meta property="article:tag" content="Python"><meta property="article:tag" content="è„šæœ¬"><meta property="article:tag" content="Xcode"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://navimark.github.io/img/PostIndexImg/Older/add-logo-for-ios-project.png"><title>ç»™ Xcode å·¥ç¨‹çš„ AppIcon æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯ - å­éé±¼</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/xcode.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"navimark.github.io",root:"/",version:"1.8.14",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:6},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:15186363,google:"UA-154660540-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:1278975811,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body><header style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>å­éé±¼</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="ç»™ Xcode å·¥ç¨‹çš„ AppIcon æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-08-13 18:52" pubdate>2020å¹´8æœˆ13æ—¥ æ™šä¸Š</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 14k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 118 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">ç»™ Xcode å·¥ç¨‹çš„ AppIcon æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯</h1><div class="markdown-body"><h1 id="éœ€æ±‚ç”±æ¥"><a href="#éœ€æ±‚ç”±æ¥" class="headerlink" title="éœ€æ±‚ç”±æ¥"></a>éœ€æ±‚ç”±æ¥</h1><p>æ—¥å¸¸å¼€å‘è¿­ä»£ä¸­ï¼Œä¸ºäº†èƒ½è®©éœ€æ±‚èƒ½å¤Ÿè¢«åŠæ—¶éªŒæ”¶ã€è®©é—®é¢˜ / bug èƒ½å¾—åˆ°åŠæ—¶éªŒè¯ï¼Œæˆ‘ä»¬ç¼–å†™çš„ä»£ç éœ€è¦æŒç»­åœ°äº¤ä»˜ï¼Œä¸ºæ­¤æˆ‘ä»¬æ­å»ºäº† Jenkins è‡ªåŠ¨å·¥å…·æ¥äº¤ä»˜ç‰ˆæœ¬ã€‚</p><p>æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¼šå¯¹åŒä¸€ä¸ª App å¹¶è¡Œå¼€å‘ä¸åŒçš„ç‰ˆæœ¬ï¼Œéšç€ä¸åŒåŠŸèƒ½çš„ä¸åŒç‰ˆæœ¬çš„åŒä¸€ App çš„äº¤ä»˜ï¼ˆå†…éƒ¨æµ‹è¯•ï¼‰ï¼Œäº§å“åŒå­¦å’Œæµ‹è¯•åŒå­¦å¯èƒ½ä¼šæä¸æ¸…æ¥šè‡ªå·±æ‰‹æœºä¸Šå®‰è£…çš„åˆ°åº•æ˜¯å“ªä¸ªç‰ˆæœ¬ã€å¯¹åº”ç€å“ªä¸ªéœ€æ±‚æˆ–é—®é¢˜è¦è¢«éªŒè¯ï¼Œä»–ä»¬å½“ç„¶å¯ä»¥è¿›å…¥ App çš„â€œå…³äº Appâ€çš„é¡µé¢æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½†æ˜¯å¹³æ·»äº†æ“ä½œæ­¥éª¤å’Œç›¸å¯¹åº”çš„æ—¶é—´æˆæœ¬ï¼Œè€Œä¸”å¯¹äºæŸäº›é—ªé€€é—®é¢˜çš„åé¦ˆï¼Œæˆ‘ä»¬å¼€å‘å¹¶ä¸å¸Œæœ›å¤šå¯åŠ¨ä¸€æ¬¡ App æ¥ç ´åå¯èƒ½çš„æ²™ç›’/æ—¥å¿—ç°åœºã€‚</p><p>ä¸ºäº†äº†å´è¿™ä¸€çƒ¦æ¼ï¼Œæˆ‘ä»¬æ‰“ç®—ç»“åˆå½“å‰åœ¨ç”¨çš„ Jenkins å°† <strong>App çš„ç‰ˆæœ¬ã€ä»£ç èŠ‚ç‚¹ä½ç½®ã€ä»£ç åˆ†æ”¯å</strong>ç›´æ¥å±•ç¤ºåœ¨ AppIcon ä¸Šï¼Œä»¥ä¾¿ä¸éœ€è¦è¦æ‰“å¼€ App æ—¶ä¹Ÿèƒ½çŸ¥é“è¿™äº›ä¿¡æ¯ã€‚</p><h1 id="æ–¹æ¡ˆè°ƒç ”"><a href="#æ–¹æ¡ˆè°ƒç ”" class="headerlink" title="æ–¹æ¡ˆè°ƒç ”"></a>æ–¹æ¡ˆè°ƒç ”</h1><ol><li><p>ä»‹å…¥æ—¶æœº</p><p>äº¤ä»˜ç»™äº§å“åŒå­¦å’Œæµ‹è¯•åŒå­¦çš„æµ‹è¯•åŒ…æ˜¯é€šè¿‡éƒ¨ç½²åœ¨åƒåœ¾æ¡¶<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Mac Pro
">[1]</span></a></sup>ä¸Šçš„ Jenkins æ„å»ºå‡ºæ¥å¹¶åˆ†å‘çš„ï¼Œæˆ‘ä»¬é…ç½®äº†ç‰ˆæœ¬å·è‡ªå¢ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½ä¼šç”Ÿæˆä¸åŒçš„ build å·ï¼Œæ‰€ä»¥åŸºäº AppIcon çš„ä¿®æ”¹éœ€è¦åœ¨æ¯æ¬¡æ„å»ºæ—¶åŠ¨æ€ç”Ÿæˆçš„ï¼Œæ‰€ä»¥åœ¨ Jenkins æ„å»ºæ—¶ç»™ AppIcon åŠ ä¸Šè¿™äº›ä¿¡æ¯æ˜¯æœ€åˆé€‚çš„ï¼Œå¯ä»¥æ”¾åˆ°â€œæ„å»ºâ€æ­¥éª¤ä¸­ï¼š<br><img src="4b4dbb8b/1.png" srcset="/img/loading.gif" lazyload alt=""></p></li><li><p>å±•ç¤ºçš„ä¿¡æ¯</p><p>éœ€è¦çš„åŸºæœ¬ä¿¡æ¯ï¼šApp ç‰ˆæœ¬ã€æ„å»ºçš„åˆ†æ”¯åå’Œ commit-hashï¼ŒApp ç‰ˆæœ¬å¯ä»¥åœ¨ Info.plist æˆ– <code>project.pbxproj</code> ä¸­è·å–ï¼Œæ„å»ºåˆ†æ”¯ä¿¡æ¯å¯ä»¥é€šè¿‡ git å‘½ä»¤è·å–ï¼Œé—®é¢˜ä¸å¤§ğŸ¤”</p></li><li><p>æŠ€æœ¯ç‚¹</p><p>é¢„æœŸæµç¨‹æ˜¯å°†ä¸Šè¿°åŸºç¡€å‚æ•°åŠ¨æ€æ·»åŠ åˆ° AppIcon ä¸Šçš„ï¼Œæ¶‰åŠåˆ°ä¸€äº›å›¾ç‰‡å¤„ç†æ­¥éª¤ï¼Œè¿™æ–¹é¢å¾…é€‰çš„æ–¹æ¡ˆæœ‰ <a target="_blank" rel="noopener" href="https://github.com/ImageMagick/ImageMagick"><code>ImageMagick</code></a>ï¼Œå…¶ä»–æ–¹é¢çœ‹èµ·æ¥æ²¡æœ‰æŠ€æœ¯éš¾ç‚¹</p></li><li><p>å¼€å‘è¯­è¨€</p><p><code>Shell</code> ä¸ç³»ç»Ÿç»“åˆç´§å¯†ï¼Œä¸æ“ä½œç³»ç»Ÿäº¤äº’æ—¶æœ‰å¤©ç„¶çš„ä¼˜åŠ¿ï¼Œä¸ªäººè®¤ä¸º <code>Shell</code> ç¼–å†™çš„ç¨‹åºåœ¨ç¯‡å¹…çŸ­å°æ—¶æ— å¯åŒ¹æ•Œï¼Œä½†å½“ç¯‡å¹…è¿‡å¤§æ—¶ï¼Œé˜…è¯»æ€§å’Œ debug-able çš„èƒ½åŠ›æ€¥å‰§ä¸‹é™ï¼Œå¯¹ï¼Œå…¶å®å°±æ˜¯æˆ‘ä¸ä¼šå¤æ‚çš„ <code>Shell</code> ğŸ¤¦â€â™‚ï¸ã€‚æœ¬æ¬¡é€‰æ‹© <code>Python</code>ï¼Œå®ƒæ¯” Shell æ›´å®¹æ˜“ä¸Šæ‰‹ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¤šåœ°ä¸“æ³¨äºä¸šåŠ¡å±‚é€»è¾‘ï¼Œå¦‚æœéœ€è¦è½®å­ï¼Œ <code>Python</code> ä¸­åº”æœ‰å°½æœ‰ã€‚å¯¹äºå›¾ç‰‡å¤„ç†ï¼Œæœ‰çŸ¥ååº“ï¼š<a target="_blank" rel="noopener" href="https://github.com/python-pillow/Pillow"><code>Pillow</code></a>ï¼Œä¼¼ä¹ä¹Ÿå¯ä»¥ä¸ç”¨ <code>ImageMagick</code></p></li></ol><h1 id="ä»£ç å¼€å‘"><a href="#ä»£ç å¼€å‘" class="headerlink" title="ä»£ç å¼€å‘"></a>ä»£ç å¼€å‘</h1><ol><li><p>å®šä¹‰å¤–éƒ¨æ¥å£</p><p>è™½ç„¶æˆ‘ä»¬é¡¹ç›®æ˜¯é€šè¿‡ Jenkins æ‰“åŒ…ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½ä¸åº”è¯¥è¢«åˆ’åˆ†ä¸º Jenkins æµæ°´çº¿çš„ä¸€éƒ¨åˆ†ï¼Œåº”è¯¥æ˜¯å·¥ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œè·Ÿéšå·¥ç¨‹çš„è¿­ä»£è€Œå®Œå–„ã€‚å®ƒçš„è¾“å…¥ä¸ºå¤–éƒ¨ä¼ å…¥çš„å·¥ç¨‹æ–‡ä»¶ï¼ˆ<code>.pbxproj</code>ï¼‰å’Œç›®æ ‡ <code>Target</code> åï¼Œè¾“å‡ºå³ä¸ºåŠ ä¸Šäº†ç‰ˆæœ¬ä¿¡æ¯çš„ AppIcon å›¾ç‰‡ã€‚æœ€ç»ˆé€šè¿‡å‘½ä»¤è¡Œä¼ å‚ä½œä¸ºå…¥å£ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    pathes = sys.argv[<span class="hljs-number">1</span>:] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> []<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(pathes) != <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å‚æ•°ä¸ªæ•°é”™è¯¯&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure></li><li><p>æ¥æ”¶å‚æ•°</p><p>æ¥æ”¶å¤–éƒ¨ä¼ å…¥çš„ target åå’Œå·¥ç¨‹æ–‡ä»¶è·¯å¾„åï¼Œå¯¹å‚æ•°ä½œç®€å•æ ¡éªŒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">pbproj_filepath = os.path.abspath(pathes[<span class="hljs-number">0</span>])<br>target_name = pathes[<span class="hljs-number">1</span>]<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Path(pbproj_filepath).exists():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;FATAL:&#123;&#125; ä¸å­˜åœ¨&quot;</span>.<span class="hljs-built_in">format</span>(pbproj_filepath))<br>    exit(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure></li><li><p>è·å–å·¥ç¨‹é…ç½®ä¿¡æ¯</p><p>ç‰ˆæœ¬å·ã€æ‰€ä½¿ç”¨çš„ AppIcon çš„è·¯å¾„ä¿¡æ¯éƒ½å­˜åœ¨äº <code>.pbxproj</code> ä¸­ï¼Œæ¥ä¸‹æ¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/kronenthaler/mod-pbxproj"><code>mod-pbxproj</code></a> è§£æ <code>.pbxproj</code>ã€‚</p><p>æ–°åˆ›å»ºä¸€ä¸ªç±»:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProjectInfo</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, pbproject_path: <span class="hljs-built_in">str</span>, target_name: <span class="hljs-built_in">str</span></span>):<br>        self.pbproject_path = pbproject_path<br>        self.target_name = target_name<br>        self.project = XcodeProject.load(pbproject_path)<br>        self.build_configs = self.project.objects.get_configurations_on_targets(<br>            target_name=target_name)<br>        self.release_build_config = [<br>            b <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> self.build_configs <span class="hljs-keyword">if</span> b.name == <span class="hljs-string">&#x27;Release&#x27;</span>][-<span class="hljs-number">1</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__find_icon_img_folder</span>(<span class="hljs-params">self, icon_img_name: <span class="hljs-built_in">str</span>, target_folder: <span class="hljs-built_in">str</span></span>):<br>        icon_img_path = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">for</span> root, folder_list, _ <span class="hljs-keyword">in</span> os.walk(target_folder):<br>                <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> folder_list:<br>                    <span class="hljs-keyword">if</span> file == icon_img_name:<br>                        icon_img_path = os.path.join(root, file)<br>                        <span class="hljs-keyword">raise</span> Getoutofloop()<br>        <span class="hljs-keyword">except</span> Getoutofloop:<br>            <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">return</span> icon_img_path<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__project_main_path</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> os.path.dirname(os.path.split(self.pbproject_path)[<span class="hljs-number">0</span>])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_icon_image_folder</span>(<span class="hljs-params">self</span>):<br>        name = self.release_build_config.buildSettings[<span class="hljs-string">&#x27;ASSETCATALOG_COMPILER_APPICON_NAME&#x27;</span>]<br>        <span class="hljs-keyword">if</span> name:<br>            search_folder = self.__project_main_path()<br>            icon_img_name = name+<span class="hljs-string">&#x27;.appiconset&#x27;</span><br>            <span class="hljs-keyword">return</span> self.__find_icon_img_folder(icon_img_name, search_folder)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;FATAL: AppICON è·¯å¾„æœªæ‰¾åˆ°&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get_info_plist_path</span>(<span class="hljs-params">self</span>):<br>        info_plist_path = self.release_build_config.buildSettings[<span class="hljs-string">&#x27;INFOPLIST_FILE&#x27;</span>]<br>        <span class="hljs-keyword">if</span> info_plist_path:<br>            xcode_placeholder_path = <span class="hljs-string">&#x27;$(SRCROOT)&#x27;</span>  <span class="hljs-comment"># å¯èƒ½åœ¨è·¯å¾„ä¸­å¹¶æ²¡æœ‰</span><br>            info_plist_path = info_plist_path.replace(<br>                xcode_placeholder_path, <span class="hljs-string">&#x27;&#x27;</span>)<br>            info_plist_path = info_plist_path <span class="hljs-keyword">if</span> info_plist_path[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;/&#x27;</span> <span class="hljs-keyword">else</span> info_plist_path[<span class="hljs-number">1</span>:]<br>            info_plist_path = os.path.join(<br>                self.__project_main_path(), info_plist_path)<br>        <span class="hljs-keyword">return</span> info_plist_path<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_version_info</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># å…ˆä» project è·å–ï¼Œå¦‚æœå¤±è´¥(å¤±è´¥å®šä¹‰ï¼šä¸å…¨æ˜¯ æ•°å­— å’Œ &#x27;.&#x27; ç»„æˆ)ï¼Œä» plist è·å–</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">valid_version</span>(<span class="hljs-params">main_version: <span class="hljs-built_in">str</span></span>):<br>            <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            å¦‚æœç”± . å’Œ æ•°å­—ç»„æˆï¼Œå°±æ˜¯åˆæ³•çš„ï¼›å¦‚æœå…¨éƒ¨ç”±æ•°å­—ç»„æˆï¼Œä¹Ÿæ˜¯åˆæ³•çš„</span><br><span class="hljs-string">            &quot;&quot;&quot;</span><br>            <span class="hljs-keyword">return</span> (<span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> main_version <span class="hljs-keyword">and</span> main_version.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).isdigit()) <span class="hljs-keyword">or</span> main_version.isdigit()<br><br>        main_version = self.release_build_config.buildSettings[<span class="hljs-string">&#x27;CURRENT_PROJECT_VERSION&#x27;</span>]<br>        <span class="hljs-keyword">if</span> main_version <span class="hljs-keyword">and</span> valid_version(main_version):<br>            <span class="hljs-keyword">return</span> main_version<br>        <span class="hljs-keyword">else</span>:<br>            plist_path = self.__get_info_plist_path()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;è½¬å‘ä» plist è¯»å–ç‰ˆæœ¬å·: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(plist_path))<br>            plist = <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(plist_path, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> rbf:<br>                plist = plistlib.load(rbf)<br>            <span class="hljs-keyword">if</span> plist:<br>                <span class="hljs-keyword">return</span> plist[<span class="hljs-string">&#x27;CFBundleShortVersionString&#x27;</span>]<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_git_branch_name</span>(<span class="hljs-params">self</span>):<br>        name = exe_command([<span class="hljs-string">&#x27;git&#x27;</span>, <span class="hljs-string">&#x27;symbolic-ref&#x27;</span>, <span class="hljs-string">&#x27;--short&#x27;</span>, <span class="hljs-string">&#x27;-q&#x27;</span>, <span class="hljs-string">&#x27;HEAD&#x27;</span>]).split(<span class="hljs-string">&#x27;/&#x27;</span>)[-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(name) == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(name.replace(<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)) == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> os.environ.get(<span class="hljs-string">&#x27;GIT_BRANCH&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>).split(<span class="hljs-string">&#x27;/&#x27;</span>)[-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">return</span> name<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_git_last_cmt_id</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> exe_command([<span class="hljs-string">&#x27;git&#x27;</span>, <span class="hljs-string">&#x27;rev-parse&#x27;</span>, <span class="hljs-string">&#x27;--short&#x27;</span>, <span class="hljs-string">&#x27;HEAD&#x27;</span>])<br></code></pre></td></tr></table></figure><p>åœ¨<code>ProjectInfo</code> ä¸­é¢„æœŸèƒ½å¤Ÿæ‹¿åˆ°ç‰ˆæœ¬å·ã€AppIcon æ‰€åœ¨è·¯å¾„ã€branch åã€commit-hashã€‚</p><ul><li><p>ç‰ˆæœ¬å·</p><p>ä½¿ç”¨ <code>mod-pbxproj</code> åˆå§‹åŒ–å·¥ç¨‹ï¼Œç„¶åæ‹¿åˆ° <code>CURRENT_PROJECT_VERSION</code> å¯¹åº”çš„ç‰ˆæœ¬å·ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå‘ç‚¹ï¼ŒXcode ä» v10 å‡çº§åˆ° v11 åï¼Œé»˜è®¤ä»<code>$(MARKETING_VERSION)</code>å’Œ<code>$(CURRENT_PROJECT_VERSION)</code>è·å–ä¸»ç‰ˆæœ¬å·ï¼Œä»æ—§ç‰ˆæœ¬æ ¼å¼çš„ <code>.pbxproj</code> å‡çº§åˆ° Xcode v11 åï¼ŒInfo.plist ä¸­çš„<code>Bundle version</code> ç”šè‡³æœ‰å¯èƒ½ä¸º <code>$(MARKETING_VERSION).xxx</code> ï¼Œæ‰€ä»¥è¿™é‡Œåšäº†ä¸€ä¸ªå…¼å®¹å¤„ç†ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæ˜¯ Xcode v11 åˆ›å»ºçš„å·¥ç¨‹ç‰ˆæœ¬å·å°±æ¯”è¾ƒæ¸…çˆ½ï¼Œå½“ç„¶å¯¹äºæˆ‘ä»¬è¿™ç§æ—§ç‰ˆæœ¬ Xcode åˆ›å»ºçš„å·¥ç¨‹ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ‰‹åŠ¨å¤„ç†ä¸€æ¬¡ï¼Œå°†ç‰ˆæœ¬å·æ”¹æˆæ–°ç‰ˆæœ¬çš„æ ·å¼ã€‚</p></li><li><p>AppIcon è·¯å¾„</p><p>æ‹¿åˆ°å·¥ç¨‹æ‰€ä½¿ç”¨çš„çš„ AppIcon æ–‡ä»¶å¤¹åå­—åï¼Œå†éå†æ‰¾åˆ° AppIcon æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„ï¼Œéå†æ—¶æ¶‰åŠåˆ°è·³å‡ºåŒé‡å¾ªç¯çš„é—®é¢˜ï¼Œè¿™é‡Œæ‰¾åˆ°äº†ä¸ªäººè§‰å¾—æ¯”è¾ƒ trick çš„æ–¹å¼ï¼Œå³é€šè¿‡æŠ›å‡ºä¸€ä¸ªå·²çŸ¥çš„å¼‚å¸¸ <code>Getoutofloop</code> æ¥ç»“æŸåŒé‡ä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Getoutofloop</span>(<span class="hljs-title class_ inherited__">Exception</span>):<br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><p>è€Œä¹‹æ‰€ä»¥éœ€è¦éå†ï¼Œæ˜¯å› ä¸ºæˆ‘ä» <code>.pbxproj</code> ä¸­æ‰¾ä¸åˆ°å¯ä»¥ç›´æ¥â€œå–â€å‡ºæ¥ç”¨çš„è·¯å¾„ï¼Œåªèƒ½ä½¿ç”¨è¿™ç§ä¸ä¸¥è°¨çš„æ–¹å¼ï¼Œå¦‚æœæœ‰æ›´ä¼˜é›…çš„æ–¹å¼ï¼Œè¯·ä¸åæŒ‡æ•™ã€‚</p></li><li><p>branch åå’Œæœ€åä¸€æ¬¡ commit-hash</p><p>è¿™ç§è·å– <code>git</code> ç›¸å…³ä¿¡æ¯çš„ï¼Œä½¿ç”¨å‘½ä»¤è¡Œåº”è¯¥æ˜¯æœ€å¿«æ·çš„ï¼Œæ‰€ä»¥å°è£…äº†ä¸€ä¸ªç®€å•çš„æ‰§è¡Œ Shell å‘½ä»¤çš„å‡½æ•° <code>exe_command</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">exe_command</span>(<span class="hljs-params"><span class="hljs-built_in">list</span></span>):<br>    result = subprocess.run(<span class="hljs-built_in">list</span>, stdout=subprocess.PIPE)<br>    <span class="hljs-keyword">return</span> result.stdout.decode(<span class="hljs-string">&quot;utf-8&quot;</span>).strip(<span class="hljs-string">&#x27;\n&#x27;</span>)<br></code></pre></td></tr></table></figure><p>è·å–åˆ†æ”¯åé‡åˆ°çš„ä¸€ä¸ªå‘ç‚¹ï¼šå‘ Jenkins æŒ‡å®šåˆ†æ”¯ååï¼Œè¢« pull åˆ°æœ¬åœ°çš„ä»£ç ä¼¼ä¹æ˜¯æŒ‡å‘ä¸€ä¸ªä¸´æ—¶åˆ†æ”¯ï¼Œé€šè¿‡ Git å‘½åå¹¶æ²¡èƒ½è·å–åˆ°åˆ†æ”¯åï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡è·å– Jenkins çš„ç¯å¢ƒå˜é‡ <code>GIT_BRANCH</code> æ¥è·å–åˆ†æ”¯å</p></li></ul></li><li><p>ç»™å›¾ç‰‡åŠ ä¸Šè‡ªå®šä¹‰æ–‡å­—ä¿¡æ¯ï¼Œå°è£…åœ¨ <code>AddVersionInfo</code> ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AddVersionInfo</span>():<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, img_folder: <span class="hljs-built_in">str</span>, version: <span class="hljs-built_in">str</span>, branch_name: <span class="hljs-built_in">str</span>, commit_id: <span class="hljs-built_in">str</span></span>):<br>        self.img_folder = img_folder<br>        self.version = version<br>        self.branch_name = branch_name<br>        self.commit_id = commit_id<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add_img_blur</span>(<span class="hljs-params">cls, img, blur_rect: <span class="hljs-built_in">tuple</span></span>):<br>        img = img.convert(<span class="hljs-string">&quot;RGB&quot;</span>)<br>        img.load()<br>        mask = Image.new(<span class="hljs-string">&#x27;L&#x27;</span>, img.size, <span class="hljs-number">0</span>)<br>        draw = ImageDraw.Draw(mask)<br>        <span class="hljs-comment"># å·¦ä¸Šè§’ç‚¹ï¼Œå³ä¸‹è§’ç‚¹</span><br>        draw.rectangle([blur_rect[:<span class="hljs-number">2</span>], img.size], fill=<span class="hljs-number">255</span>)<br>        height = img.size[<span class="hljs-number">0</span>]<br>        blurred = img.<span class="hljs-built_in">filter</span>(ImageFilter.GaussianBlur(height * <span class="hljs-number">0.06</span>))<br>        img.paste(blurred, mask=mask)<br>        <span class="hljs-keyword">return</span> img<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add_img_txt</span>(<span class="hljs-params">cls, img, draw, txt: <span class="hljs-built_in">str</span>, top_margins: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>):<br>        top_margin = top_margins[<span class="hljs-number">0</span>]<br>        myFont = ImageFont.truetype(<span class="hljs-string">&quot;SFNSMono.ttf&quot;</span>, <span class="hljs-built_in">int</span>(<span class="hljs-number">0.14</span> * img.size[<span class="hljs-number">0</span>]))<br>        txt_size = draw.textsize(txt, font=myFont)<br>        versionTxtO = ((img.size[<span class="hljs-number">0</span>] - txt_size[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>, top_margin)<br>        draw.text(versionTxtO, txt, fill=<span class="hljs-string">&quot;black&quot;</span>, font=myFont)<br>        top_margins[<span class="hljs-number">0</span>] = top_margin + txt_size[<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">return</span> img<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_single_img</span>(<span class="hljs-params">self, img_path: <span class="hljs-built_in">str</span></span>):<br>        img = Image.<span class="hljs-built_in">open</span>(img_path)<br>        blur_rect = (<span class="hljs-number">0</span>, <span class="hljs-built_in">int</span>(img.size[<span class="hljs-number">1</span>]*<span class="hljs-number">0.5</span>),<br>                    <span class="hljs-built_in">int</span>(img.size[<span class="hljs-number">0</span>]), <span class="hljs-built_in">int</span>(img.size[<span class="hljs-number">1</span>]*<span class="hljs-number">0.5</span>))<br>        img = AddVersionInfo.__add_img_blur(img, blur_rect)<br><br>        draw = ImageDraw.Draw(img)<br>        last_top_margin = img.size[<span class="hljs-number">1</span>]*<span class="hljs-number">0.5</span> + <span class="hljs-number">2</span><br>        <span class="hljs-keyword">for</span> txt <span class="hljs-keyword">in</span> [self.version, self.branch_name, self.commit_id]:<br>            margin_wrapper = [last_top_margin]<br>            img = AddVersionInfo.__add_img_txt(<br>                img, draw, txt, top_margins=margin_wrapper)<br>            last_top_margin = margin_wrapper[<span class="hljs-number">0</span>]<br>        img.save(img_path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_version_info</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ç‰ˆæœ¬å·:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.version))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åˆ†æ”¯:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.branch_name))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸Šæ¬¡æäº¤:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.commit_id))<br>        <span class="hljs-keyword">for</span> root, _, file_list <span class="hljs-keyword">in</span> os.walk(self.img_folder):<br>            <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> file_list:<br>                full_path = os.path.join(root, file)<br>                <span class="hljs-keyword">if</span> os.path.isfile(full_path) <span class="hljs-keyword">and</span> imghdr.what(full_path) <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;png&#x27;</span>]:<br>                    self.add_single_img(full_path)<br></code></pre></td></tr></table></figure><p>é¢„æœŸæ˜¯ç»™ <code>.appiconset</code> ä¸­æ‰€æœ‰å›¾ç‰‡åŠ ä¸ŠæŒ‡å®šæ–‡å­—ä¿¡æ¯ã€‚å…ˆåœ¨å›¾ç‰‡çš„ä¸‹åŠéƒ¨åˆ†æ·»åŠ æ¨¡ç³Šæ•ˆæœï¼Œé¿å…æ–‡å­—çœ‹ä¸æ¸…ï¼Œæ¥ç€åœ¨æ¨¡ç³Šéƒ¨åˆ†ä»ä¸Šè‡³ä¸‹ç»˜åˆ¶æ–‡æœ¬ï¼Œä¿å­˜ã€‚ç”±äºå›¾ç‰‡å¤§å°ä¸ä¸€ï¼Œæ‰€ä»¥é€‰æ‹©äº†çº¤ç»†ã€æ¸…æ™°çš„ç³»ç»Ÿå­—ä½“ï¼Œå¹¶ä¸”æ ¹æ®å›¾ç‰‡å¤§å°å†³å®šæ¨¡ç³Šç¨‹åº¦å’Œæ–‡å­—å­—å·ã€‚</p></li><li><p>è¿è¡Œä¸éƒ¨ç½²</p><ul><li><p>åŠ ä¸Šä¾èµ–:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageFilter, ImageDraw, ImageFont<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> imghdr<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><span class="hljs-keyword">import</span> typing<br><span class="hljs-keyword">import</span> plistlib<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">from</span> pbxproj <span class="hljs-keyword">import</span> PBXNativeTarget<br><span class="hljs-keyword">from</span> pbxproj <span class="hljs-keyword">import</span> XcodeProject<br><span class="hljs-keyword">import</span> os<br></code></pre></td></tr></table></figure></li><li><p>å®Œå–„å…¥å£ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>pathes = sys.argv[<span class="hljs-number">1</span>:] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> []<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(pathes) != <span class="hljs-number">2</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å‚æ•°ä¸ªæ•°é”™è¯¯&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    pbproj_filepath = os.path.abspath(pathes[<span class="hljs-number">0</span>])<br>    target_name = pathes[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Path(pbproj_filepath).exists():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;FATAL:&#123;&#125; ä¸å­˜åœ¨&quot;</span>.<span class="hljs-built_in">format</span>(pbproj_filepath))<br>        exit(<span class="hljs-number">1</span>)<br>    pf = ProjectInfo(pbproj_filepath, target_name)<br>    avi = AddVersionInfo(pf.get_icon_image_folder(),<br>                        pf.get_version_info(),<br>                        pf.get_git_branch_name(),<br>                        pf.get_git_last_cmt_id())<br>    avi.add_version_info()<br></code></pre></td></tr></table></figure></li><li><p>éƒ¨ç½²<br>åœ¨ Jenkins çš„ <code>Execute shell</code> ä¸­åŠ ä¸Šè°ƒç”¨è¯­å¥:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python3 ./ScriptsProvisoningfiles/add_logo.py ./MachOExploration.xcodeproj/project.pbxproj MachOExploration<br></code></pre></td></tr></table></figure><p>ç„¶åå†æ‰§è¡Œæ„å»ºåŠ¨ä½œã€‚</p></li></ul></li></ol><h1 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h1><p>è¿è¡Œ Jenkins çš„åƒåœ¾æ¡¶çš„ç®—åŠ›å……è¶³ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è€ƒè™‘ç¼“å­˜ï¼Œå°±æ¯æ¬¡æ„å»ºå†…æµ‹åŒ…æ—¶éƒ½ç‰ˆæœ¬åŒ–å¤„ç† AppIconã€‚å¦‚æœæ„å»ºç»™ Appleï¼Œå°±å»æ‰å¯¹ <code>add_logo.py</code> çš„è°ƒç”¨ã€‚ä¹Ÿå¯ä»¥ä½œä¸º Build Phrase æ·»åŠ åˆ° Xcode ä¸­ï¼Œå®ç° Xcode build æ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œä½†æ˜¯è¿™æ—¶å€™å°±è¦è€ƒè™‘ AppIcon çš„å¤ç”¨å’Œç¼“å­˜é—®é¢˜äº†ã€‚</p><p>ç›®å‰è„šæœ¬è¿˜ä¸å¤Ÿæ™ºèƒ½ï¼Œä¾èµ–çš„ä¸€å¤§å †åº“åªèƒ½æ‰‹åŠ¨å®‰è£…ï¼Œåç»­å¯ä»¥ä¼˜åŒ–ä¸ºè‡ªåŠ¨æ£€æŸ¥å’Œå®‰è£…ã€‚</p><details><summary>å®Œæ•´è„šæœ¬</summary><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># !/usr/local/bin/python3</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment">#</span><br><br>__doc__ = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment"># pip3 install Pillow --user</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageFilter, ImageDraw, ImageFont<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> imghdr<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><span class="hljs-keyword">import</span> typing<br><span class="hljs-keyword">import</span> plistlib<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">from</span> pbxproj <span class="hljs-keyword">import</span> PBXNativeTarget<br><span class="hljs-keyword">from</span> pbxproj <span class="hljs-keyword">import</span> XcodeProject<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AddVersionInfo</span>():<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, img_folder: <span class="hljs-built_in">str</span>, version: <span class="hljs-built_in">str</span>, branch_name: <span class="hljs-built_in">str</span>, commit_id: <span class="hljs-built_in">str</span></span>):<br>        self.img_folder = img_folder<br>        self.version = version<br>        self.branch_name = branch_name<br>        self.commit_id = commit_id<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add_img_blur</span>(<span class="hljs-params">cls, img, blur_rect: <span class="hljs-built_in">tuple</span></span>):<br>        img = img.convert(<span class="hljs-string">&quot;RGB&quot;</span>)<br>        img.load()<br>        mask = Image.new(<span class="hljs-string">&#x27;L&#x27;</span>, img.size, <span class="hljs-number">0</span>)<br>        draw = ImageDraw.Draw(mask)<br>        <span class="hljs-comment"># å·¦ä¸Šè§’ç‚¹ï¼Œå³ä¸‹è§’ç‚¹</span><br>        draw.rectangle([blur_rect[:<span class="hljs-number">2</span>], img.size], fill=<span class="hljs-number">255</span>)<br>        height = img.size[<span class="hljs-number">0</span>]<br>        blurred = img.<span class="hljs-built_in">filter</span>(ImageFilter.GaussianBlur(height * <span class="hljs-number">0.06</span>))<br>        img.paste(blurred, mask=mask)<br>        <span class="hljs-keyword">return</span> img<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add_img_txt</span>(<span class="hljs-params">cls, img, draw, txt: <span class="hljs-built_in">str</span>, top_margins: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>):<br>        top_margin = top_margins[<span class="hljs-number">0</span>]<br>        myFont = ImageFont.truetype(<span class="hljs-string">&quot;SFNSMono.ttf&quot;</span>, <span class="hljs-built_in">int</span>(<span class="hljs-number">0.14</span> * img.size[<span class="hljs-number">0</span>]))<br>        txt_size = draw.textsize(txt, font=myFont)<br>        versionTxtO = ((img.size[<span class="hljs-number">0</span>] - txt_size[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>, top_margin)<br>        draw.text(versionTxtO, txt, fill=<span class="hljs-string">&quot;black&quot;</span>, font=myFont)<br>        top_margins[<span class="hljs-number">0</span>] = top_margin + txt_size[<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">return</span> img<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_single_img</span>(<span class="hljs-params">self, img_path: <span class="hljs-built_in">str</span></span>):<br>        img = Image.<span class="hljs-built_in">open</span>(img_path)<br>        blur_rect = (<span class="hljs-number">0</span>, <span class="hljs-built_in">int</span>(img.size[<span class="hljs-number">1</span>]*<span class="hljs-number">0.5</span>),<br>                     <span class="hljs-built_in">int</span>(img.size[<span class="hljs-number">0</span>]), <span class="hljs-built_in">int</span>(img.size[<span class="hljs-number">1</span>]*<span class="hljs-number">0.5</span>))<br>        img = AddVersionInfo.__add_img_blur(img, blur_rect)<br><br>        draw = ImageDraw.Draw(img)<br>        last_top_margin = img.size[<span class="hljs-number">1</span>]*<span class="hljs-number">0.5</span> + <span class="hljs-number">2</span><br>        <span class="hljs-keyword">for</span> txt <span class="hljs-keyword">in</span> [self.version, self.branch_name, self.commit_id]:<br>            margin_wrapper = [last_top_margin]<br>            img = AddVersionInfo.__add_img_txt(<br>                img, draw, txt, top_margins=margin_wrapper)<br>            last_top_margin = margin_wrapper[<span class="hljs-number">0</span>]<br>        img.save(img_path)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_version_info</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ç‰ˆæœ¬å·:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.version))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åˆ†æ”¯:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.branch_name))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸Šæ¬¡æäº¤:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(self.commit_id))<br>        <span class="hljs-keyword">for</span> root, _, file_list <span class="hljs-keyword">in</span> os.walk(self.img_folder):<br>            <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> file_list:<br>                full_path = os.path.join(root, file)<br>                <span class="hljs-keyword">if</span> os.path.isfile(full_path) <span class="hljs-keyword">and</span> imghdr.what(full_path) <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;png&#x27;</span>]:<br>                    self.add_single_img(full_path)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exe_command</span>(<span class="hljs-params"><span class="hljs-built_in">list</span></span>):<br>    result = subprocess.run(<span class="hljs-built_in">list</span>, stdout=subprocess.PIPE)<br>    <span class="hljs-keyword">return</span> result.stdout.decode(<span class="hljs-string">&quot;utf-8&quot;</span>).strip(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Getoutofloop</span>(<span class="hljs-title class_ inherited__">Exception</span>):<br>    <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProjectInfo</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, pbproject_path: <span class="hljs-built_in">str</span>, target_name: <span class="hljs-built_in">str</span></span>):<br>        self.pbproject_path = pbproject_path<br>        self.target_name = target_name<br>        self.project = XcodeProject.load(pbproject_path)<br>        self.build_configs = self.project.objects.get_configurations_on_targets(<br>            target_name=target_name)<br>        self.release_build_config = [<br>            b <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> self.build_configs <span class="hljs-keyword">if</span> b.name == <span class="hljs-string">&#x27;Release&#x27;</span>][-<span class="hljs-number">1</span>]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__find_icon_img_folder</span>(<span class="hljs-params">self, icon_img_name: <span class="hljs-built_in">str</span>, target_folder: <span class="hljs-built_in">str</span></span>):<br>        icon_img_path = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">for</span> root, folder_list, _ <span class="hljs-keyword">in</span> os.walk(target_folder):<br>                <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> folder_list:<br>                    <span class="hljs-keyword">if</span> file == icon_img_name:<br>                        icon_img_path = os.path.join(root, file)<br>                        <span class="hljs-keyword">raise</span> Getoutofloop()<br>        <span class="hljs-keyword">except</span> Getoutofloop:<br>            <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">return</span> icon_img_path<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__project_main_path</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> os.path.dirname(os.path.split(self.pbproject_path)[<span class="hljs-number">0</span>])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_icon_image_folder</span>(<span class="hljs-params">self</span>):<br>        name = self.release_build_config.buildSettings[<span class="hljs-string">&#x27;ASSETCATALOG_COMPILER_APPICON_NAME&#x27;</span>]<br>        <span class="hljs-keyword">if</span> name:<br>            search_folder = self.__project_main_path()<br>            icon_img_name = name+<span class="hljs-string">&#x27;.appiconset&#x27;</span><br>            <span class="hljs-keyword">return</span> self.__find_icon_img_folder(icon_img_name, search_folder)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;FATAL: AppICON è·¯å¾„æœªæ‰¾åˆ°&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get_info_plist_path</span>(<span class="hljs-params">self</span>):<br>        info_plist_path = self.release_build_config.buildSettings[<span class="hljs-string">&#x27;INFOPLIST_FILE&#x27;</span>]<br>        <span class="hljs-keyword">if</span> info_plist_path:<br>            xcode_placeholder_path = <span class="hljs-string">&#x27;$(SRCROOT)&#x27;</span>  <span class="hljs-comment"># å¯èƒ½åœ¨è·¯å¾„ä¸­å¹¶æ²¡æœ‰</span><br>            info_plist_path = info_plist_path.replace(<br>                xcode_placeholder_path, <span class="hljs-string">&#x27;&#x27;</span>)<br>            info_plist_path = info_plist_path <span class="hljs-keyword">if</span> info_plist_path[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;/&#x27;</span> <span class="hljs-keyword">else</span> info_plist_path[<span class="hljs-number">1</span>:]<br>            info_plist_path = os.path.join(<br>                self.__project_main_path(), info_plist_path)<br>        <span class="hljs-keyword">return</span> info_plist_path<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_version_info</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># å…ˆä» project è·å–ï¼Œå¦‚æœå¤±è´¥(å¤±è´¥å®šä¹‰ï¼šä¸å…¨æ˜¯ æ•°å­— å’Œ &#x27;.&#x27; ç»„æˆ)ï¼Œä» plist è·å–</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">valid_version</span>(<span class="hljs-params">main_version: <span class="hljs-built_in">str</span></span>):<br>            <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            å¦‚æœç”± . å’Œ æ•°å­—ç»„æˆï¼Œå°±æ˜¯åˆæ³•çš„ï¼›å¦‚æœå…¨éƒ¨ç”±æ•°å­—ç»„æˆï¼Œä¹Ÿæ˜¯åˆæ³•çš„</span><br><span class="hljs-string">            &quot;&quot;&quot;</span><br>            <span class="hljs-keyword">return</span> (<span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> main_version <span class="hljs-keyword">and</span> main_version.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).isdigit()) <span class="hljs-keyword">or</span> main_version.isdigit()<br>        <span class="hljs-comment"># ä¸»åŒ…çš„ä¸»å·¥ç¨‹ç‰ˆæœ¬å·è¯»å–</span><br>        main_version = self.release_build_config.buildSettings[<span class="hljs-string">&#x27;MARKETING_VERSION&#x27;</span>]<br>        <span class="hljs-keyword">if</span> main_version <span class="hljs-keyword">and</span> valid_version(main_version):<br>            plist_path = self.__get_info_plist_path()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;è½¬å‘ä» plist è¯»å–ç‰ˆæœ¬å·: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(plist_path))<br>            plist = <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(plist_path, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> rbf:<br>                plist = plistlib.load(rbf)<br>            <span class="hljs-keyword">if</span> plist:<br>                <span class="hljs-keyword">return</span> main_version+<span class="hljs-string">&#x27;.&#x27;</span>+plist[<span class="hljs-string">&#x27;CFBundleVersion&#x27;</span>].split(<span class="hljs-string">&#x27;.&#x27;</span>)[-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_git_branch_name</span>(<span class="hljs-params">self</span>):<br>        name = exe_command([<span class="hljs-string">&#x27;git&#x27;</span>, <span class="hljs-string">&#x27;symbolic-ref&#x27;</span>, <span class="hljs-string">&#x27;--short&#x27;</span>, <span class="hljs-string">&#x27;-q&#x27;</span>, <span class="hljs-string">&#x27;HEAD&#x27;</span>]).split(<span class="hljs-string">&#x27;/&#x27;</span>)[-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(name) == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(name.replace(<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)) == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> os.environ.get(<span class="hljs-string">&#x27;GIT_BRANCH&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>).split(<span class="hljs-string">&#x27;/&#x27;</span>)[-<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">return</span> name<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_git_last_cmt_id</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> exe_command([<span class="hljs-string">&#x27;git&#x27;</span>, <span class="hljs-string">&#x27;rev-parse&#x27;</span>, <span class="hljs-string">&#x27;--short&#x27;</span>, <span class="hljs-string">&#x27;HEAD&#x27;</span>])<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>    pathes = sys.argv[<span class="hljs-number">1</span>:] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> []<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(pathes) != <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å‚æ•°ä¸ªæ•°é”™è¯¯&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        pbproj_filepath = os.path.abspath(pathes[<span class="hljs-number">0</span>])<br>        target_name = pathes[<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Path(pbproj_filepath).exists():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;FATAL:&#123;&#125; ä¸å­˜åœ¨&quot;</span>.<span class="hljs-built_in">format</span>(pbproj_filepath))<br>            exit(<span class="hljs-number">1</span>)<br>        pf = ProjectInfo(pbproj_filepath, target_name)<br>        avi = AddVersionInfo(pf.get_icon_image_folder(),<br>                             pf.get_version_info(),<br>                             pf.get_git_branch_name(),<br>                             pf.get_git_last_cmt_id())<br>        avi.add_version_info()<br></code></pre></td></tr></table></figure></details><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>Mac Pro <a href="#fnref:1" rev="footnote" class="footnote-backref">â†©</a></span></span></li></ol></div></section></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7/">å¼€å‘æŠ€å·§</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E5%B7%A5%E5%85%B7/">å·¥å…·</a> <a class="hover-with-bg" href="/tags/iOS/">iOS</a> <a class="hover-with-bg" href="/tags/Python/">Python</a> <a class="hover-with-bg" href="/tags/%E8%84%9A%E6%9C%AC/">è„šæœ¬</a> <a class="hover-with-bg" href="/tags/Xcode/">Xcode</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/fc800951.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">OC runtime ä¸­çš„ load å’Œ initialize</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/posts/349e475.html"><span class="hidden-mobile">fishhook åŸç†åŠå…¶æºç é˜…è¯»</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js",(function(){var i=Object.assign({appId:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appKey:"Y6tve5P6QYMvu13i6cXcL8ly",path:"window.location.pathname",placeholder:"è¯´ç‚¹ä»€ä¹ˆ",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!1,serverURLs:null,emojiCDN:null,emojiMaps:null,enableQQ:!1,appid:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appkey:"Y6tve5P6QYMvu13i6cXcL8ly"},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><span id="cnzz_stat_icon_1278975811" style="display:none"></span></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?15186363";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154660540-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script defer src="//s4.cnzz.com/z_stat.php?id=1278975811&show=pic" type="text/javascript"></script><script src="/js/boot.js"></script></body></html>