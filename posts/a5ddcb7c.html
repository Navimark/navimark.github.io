<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Navimark"><meta name="keywords" content="ç¬¦å·è¡¨,åŠ¨æ€ç»‘å®š,rebase,rebinding"><meta name="description" content="Mach-O æ–‡ä»¶ç»“æ„è¯¦è§£ä¸­åˆ†æäº† Mach-O çš„æ„æˆï¼Œä»‹ç»äº†éƒ¨åˆ† Segment å’Œ Section çš„ç»“æ„å’Œå…¶ä½œç”¨ï¼Œç›¸å½“äºæ˜¯é™æ€åˆ†æã€‚è¿™ç¯‡æ–‡ç« å°†åˆ†æ Mach-O åŠ è½½æ—¶åŠ¨æ€é“¾æ¥è¿‡ç¨‹ï¼ŒåŠ æ·±è‡ªå·±çš„ç†è§£ã€‚  å¯åŠ¨è¿‡ç¨‹iOS App çš„å¯åŠ¨è¿‡ç¨‹å¤§æ¦‚åˆ†ä¸ºè¿™å‡ ä¸ªæ­¥éª¤ï¼š  å†…æ ¸åˆå§‹åŒ–éƒ¨åˆ†ï¼Œè´Ÿè´£å°† App çš„ Mach-O Header æ˜ å°„åˆ°å†…å­˜ä¸­è¿›è¡Œå¤„ç†ç„¶åè°ƒç”¨ dyld  dyld è´Ÿè´£å°† App"><meta property="og:type" content="article"><meta property="og:title" content="Mach-O åŠ è½½æ—¶çš„åŠ¨æ€é“¾æ¥"><meta property="og:url" content="https://navimark.github.io/posts/a5ddcb7c.html"><meta property="og:site_name" content="å­éé±¼"><meta property="og:description" content="Mach-O æ–‡ä»¶ç»“æ„è¯¦è§£ä¸­åˆ†æäº† Mach-O çš„æ„æˆï¼Œä»‹ç»äº†éƒ¨åˆ† Segment å’Œ Section çš„ç»“æ„å’Œå…¶ä½œç”¨ï¼Œç›¸å½“äºæ˜¯é™æ€åˆ†æã€‚è¿™ç¯‡æ–‡ç« å°†åˆ†æ Mach-O åŠ è½½æ—¶åŠ¨æ€é“¾æ¥è¿‡ç¨‹ï¼ŒåŠ æ·±è‡ªå·±çš„ç†è§£ã€‚  å¯åŠ¨è¿‡ç¨‹iOS App çš„å¯åŠ¨è¿‡ç¨‹å¤§æ¦‚åˆ†ä¸ºè¿™å‡ ä¸ªæ­¥éª¤ï¼š  å†…æ ¸åˆå§‹åŒ–éƒ¨åˆ†ï¼Œè´Ÿè´£å°† App çš„ Mach-O Header æ˜ å°„åˆ°å†…å­˜ä¸­è¿›è¡Œå¤„ç†ç„¶åè°ƒç”¨ dyld  dyld è´Ÿè´£å°† App"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://navimark.github.io/img/PostIndexImg/Older/Mach-O-dylb-stub-bind-md.png"><meta property="article:published_time" content="2020-06-30T11:13:38.000Z"><meta property="article:modified_time" content="2024-04-19T08:50:08.049Z"><meta property="article:author" content="Navimark"><meta property="article:tag" content="åº•å±‚"><meta property="article:tag" content="Mach-O"><meta property="article:tag" content="åŠ è½½æ–¹å¼"><meta property="article:tag" content="lldb"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://navimark.github.io/img/PostIndexImg/Older/Mach-O-dylb-stub-bind-md.png"><title>Mach-O åŠ è½½æ—¶çš„åŠ¨æ€é“¾æ¥ - å­éé±¼</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/xcode.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"navimark.github.io",root:"/",version:"1.8.14",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:6},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:15186363,google:"UA-154660540-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:1278975811,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body><header style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>å­éé±¼</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Mach-O åŠ è½½æ—¶çš„åŠ¨æ€é“¾æ¥"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-06-30 19:13" pubdate>2020å¹´6æœˆ30æ—¥ æ™šä¸Š</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 7.1k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 60 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Mach-O åŠ è½½æ—¶çš„åŠ¨æ€é“¾æ¥</h1><div class="markdown-body"><blockquote><p><a href="https://navimark.github.io/posts/a58100d4.html">Mach-O æ–‡ä»¶ç»“æ„è¯¦è§£</a>ä¸­åˆ†æäº† Mach-O çš„æ„æˆï¼Œä»‹ç»äº†éƒ¨åˆ† <code>Segment</code> å’Œ <code>Section</code> çš„ç»“æ„å’Œå…¶ä½œç”¨ï¼Œç›¸å½“äºæ˜¯é™æ€åˆ†æã€‚è¿™ç¯‡æ–‡ç« å°†åˆ†æ Mach-O åŠ è½½æ—¶åŠ¨æ€é“¾æ¥è¿‡ç¨‹ï¼ŒåŠ æ·±è‡ªå·±çš„ç†è§£ã€‚</p></blockquote><h2 id="å¯åŠ¨è¿‡ç¨‹"><a href="#å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹"></a>å¯åŠ¨è¿‡ç¨‹</h2><p>iOS App çš„å¯åŠ¨è¿‡ç¨‹å¤§æ¦‚åˆ†ä¸ºè¿™å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>å†…æ ¸åˆå§‹åŒ–éƒ¨åˆ†ï¼Œè´Ÿè´£å°† App çš„ Mach-O Header æ˜ å°„åˆ°å†…å­˜ä¸­è¿›è¡Œå¤„ç†ç„¶åè°ƒç”¨ <code>dyld</code></li><li><code>dyld</code> è´Ÿè´£å°† App å¤„ç†ä¸ºä¸€ä¸ªå¯ä»¥è¿è¡Œçš„çŠ¶æ€ï¼Œé€šè¿‡æ·»åŠ  <code>DYLD_PRINT_STATISTICS</code> ç¯å¢ƒå˜é‡å¯ä»¥æŸ¥çœ‹å„ä¸ªé˜¶æ®µï¼ŒåŒ…æ‹¬ï¼š<ul><li>åŠ è½½ Mach-O çš„ä¾èµ–åº“ã€‚æ‰€ä¾èµ–çš„åº“ä¿¡æ¯åœ¨ Mach-O çš„ <code>Load Commands</code> ä¸­å¯ä»¥çœ‹åˆ°</li><li>Fix-upsï¼Œåœ°å€ä¿®æ­£ã€‚å½“æ‰€ä¾èµ–çš„åŠ¨æ€é“¾æ¥åº“åŠ è½½å®Œæˆåï¼Œå®ƒä»¬å½¼æ­¤é—´ç‹¬ç«‹ï¼Œè¯¥é˜¶æ®µè´Ÿè´£å°†å®ƒä»¬ç»‘å®šèµ·æ¥ã€‚å…¶ä¸­ Fix-ups åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š<ol><li><code>Rebasing</code>ï¼šå°† App å¯è¡Œæ–‡ä»¶ä¸­æŒ‡å‘å†…éƒ¨çš„æŒ‡é’ˆè¿›è¡ŒæŒ‡å‘ä¿®æ­£</li><li><code>Binding</code>ï¼šä¿®å¤ App å¯æ‰§è¡Œæ–‡ä»¶ä¸­æŒ‡å‘å¤–éƒ¨çš„æŒ‡é’ˆ</li></ol></li><li>ObjC ç¯å¢ƒé…ç½®ã€‚è¯¥é˜¶æ®µè¿›è¡Œ<code>Class</code>ã€<code>Category</code>çš„æ³¨å†Œå’Œ<code>SEL</code>çš„åˆ†é…ã€‚</li><li>initializer ã€‚<code>+load</code> åœ¨è¯¥é˜¶æ®µæ‰§è¡Œ</li></ul></li><li>è¿›å…¥ <code>main()</code> å’Œ <code>UIApplicationDelegate</code> å›è°ƒçŠ¶æ€æ‰§è¡Œé˜¶æ®µï¼Œå±•ç¤ºè‡ªå®šä¹‰ UI</li></ol><h2 id="ç¬¦å·ç»‘å®šï¼ˆBindingï¼‰"><a href="#ç¬¦å·ç»‘å®šï¼ˆBindingï¼‰" class="headerlink" title="ç¬¦å·ç»‘å®šï¼ˆBindingï¼‰"></a>ç¬¦å·ç»‘å®šï¼ˆBindingï¼‰</h2><p>Mach-O åŠ è½½æ—¶ï¼Œç¬¦å·åˆ†æˆäº†æ‡’åŠ è½½ç¬¦å·å’Œéæ‡’åŠ è½½ç¬¦å·ï¼Œéæ‡’åŠ è½½ç¬¦å·åœ¨ <code>dyld</code> åŠ è½½ Mach-O æ—¶å°±ä¼šç»‘å®šçœŸå®åœ°å€ï¼›å¯¹äºæ¥è‡ªäºç³»ç»ŸåŠ¨æ€é“¾æ¥åº“æˆ–è€…ç‹¬ç«‹äº Main Execute Binaryï¼ˆMach-Oï¼‰ ä¹‹å¤–çš„æ‡’åŠ è½½ç¬¦å·ï¼Œåªåœ¨åœ¨å®ƒä»¬ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶æ‰ä¼šç»‘å®šçœŸå®åœ°å€ï¼Œåç»­è°ƒç”¨æ—¶å°†ç›´æ¥ä½¿ç”¨çœŸå®åœ°å€ã€‚</p><p>Demo äºŒè¿›åˆ¶ <a target="_blank" rel="noopener" href="https://github.com/Navimark/MachOExploration/blob/master/HelloWorld/HelloWorld">HelloWorld</a> ä¸­è°ƒç”¨äº†æ¥è‡ªäºç³»ç»ŸåŠ¨æ€åº“çš„ <code>NSLog</code>ï¼Œä¸‹é¢å°†é€šè¿‡è¯¥äºŒè¿›åˆ¶åŠå…¶æºç æ¥åˆ†æç¬¦å·çš„ç»‘å®šè¿‡ç¨‹ã€‚</p><p>ä¸‹é¢ä¼šå…ˆä½¿ç”¨ MachOView é™æ€æŸ¥çœ‹ç›¸å…³çš„ Section å’Œ Segment é™æ€åˆ†æï¼Œç„¶åå•æ­¥åŠ¨æ€è°ƒè¯•éªŒè¯ã€‚</p><h4 id="1-TEXT-stubs"><a href="#1-TEXT-stubs" class="headerlink" title="1. __TEXT,__stubs"></a>1. <code>__TEXT,__stubs</code></h4><p><code>__TEXT</code> æ®µå­˜æ”¾çš„æ˜¯ä»£ç æŒ‡ä»¤ï¼Œå…¶ä¸­ <code>__TEXT,__stubs</code> å­˜æ”¾çš„æ˜¯å½“å‰ <code>Imageï¼ˆé•œåƒï¼‰</code> å¤–éƒ¨ç¬¦å·çš„æ¡©ç‚¹ã€‚ä¸‹å›¾æ˜¯ <code>HelloWorld</code> çš„ <code>__TEXT,__stubs</code> éƒ¨åˆ†ï¼š<br><img src="a5ddcb7c/1.png" srcset="/img/loading.gif" lazyload alt="__stubs"><br>å…¶ä¸­ Data å­—æ®µæ˜¯æœºå™¨ç ï¼Œå¯ä»¥æŒ‰ç…§ AArch64 æŒ‡ä»¤é›†çš„ç¼–ç è§„åˆ™<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="ARM64 æ±‡ç¼–â€”â€”å¯„å­˜å™¨å’ŒæŒ‡ä»¤
">[1]</span></a></sup>ç¿»è¯‘æˆæ±‡ç¼–ä»£ç ï¼Œä½¿ç”¨ Hopper Disassembler æ‰“å¼€äºŒè¿›åˆ¶ï¼ˆæ³¨æ„ä¸è¦å‹¾é€‰ Mach-O AArch64 Options çš„ Resolve Lazy Bindings é€‰é¡¹ï¼‰ï¼Œå®šä½åˆ° <code>NSLog</code>ï¼š</p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="a5ddcb7c/2.png" srcset="/img/loading.gif" lazyload alt="NSLog1"></div><div class="group-image-wrap"><img src="a5ddcb7c/3.png" srcset="/img/loading.gif" lazyload alt="NSLog2"></div><div class="group-image-wrap"><img src="a5ddcb7c/4.png" srcset="/img/loading.gif" lazyload alt="NSLog3"></div></div></div><p>Hopper å³è¾¹ Instruction Encoding åŒºåŸŸçš„ 16 è¿›åˆ¶ä¸²å¯¹åº”å½“å‰é€‰ä¸­çš„æ±‡ç¼–å‘½ä»¤ï¼Œä¸‰æ¡å‘½ä»¤ç»„åˆèµ·æ¥çš„ 16 è¿›åˆ¶ä¸² <code>1F2003D510D7005800021FD6</code> åˆšå¥½å°±æ˜¯ MachOView ä¸­ <code>NSLog</code> çš„ Data å€¼ã€‚è¿™ä¸‰è¡ŒæŒ‡ä»¤è®©è·³è½¬åˆ° <code>0x100008008</code> å»æ‰§è¡Œï¼Œ<code>0x100008008</code> å‡å» VM(<code>(LC_SEGMENT_64),__PAGEZERO.VMSize</code>) çš„åˆå§‹åç§»å€¼ï¼š<code>0x100000000</code>(4294967296) ï¼Œå¾—åˆ° <code>0x000008008</code>ï¼Œå®ƒå¯¹åº” Mach-O ä¸­ <code>__DATA.__la_symbol_ptr</code> çš„èµ·å§‹ä½ç½®ã€‚<br><img src="a5ddcb7c/5.png" srcset="/img/loading.gif" lazyload alt="__stubs"><br>ç”±äº <code>__TEXT</code> æ˜¯åªè¯»çš„ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨ Mach-O ç»è¿‡äº† ASLR å’Œ PIE åä»ç„¶èƒ½å¤Ÿæ­£ç¡®åœ°å®šä½å¤–éƒ¨ç¬¦å·çš„åœ°å€ï¼Œå®ŒæˆåŠ¨æ€é“¾æ¥ï¼Œ<code>__TEXT,__stubs</code> å……å½“äº†è·³æ¿ä½œç”¨ï¼Œå½“æœ‰äººè¦è°ƒç”¨ stub ç¬¦å·æ—¶ï¼Œå®ƒä¾¿å°†è°ƒç”¨æµç¨‹è½¬å‘äº†ä¸€ä¸ªå¯å†™åŒºåŸŸ <code>__DATA.__la_symbol_ptr</code>ï¼Œè€Œè¯¥åŒºåŸŸå°†å­˜æ”¾çœŸæ­£çš„ç¬¦å·åœ°å€</p><h4 id="2-DATA-la-symbol-ptr"><a href="#2-DATA-la-symbol-ptr" class="headerlink" title="2. __DATA.__la_symbol_ptr"></a>2. <code>__DATA.__la_symbol_ptr</code></h4><p><code>__la_symbol_ptr</code> å­˜æ”¾ lazy-binding çš„å‡½æ•°æŒ‡é’ˆä¿¡æ¯ï¼Œåœ¨ Hopper ä¸­åŒå‡» <code>NSLog</code> çš„åœ°å€ <code>0x100008008</code>ï¼Œå°†ä¼šè·³è½¬åˆ°ï¼š<br><img src="a5ddcb7c/6.png" srcset="/img/loading.gif" lazyload alt="__stubs"><br>æ˜¯ä¸€ä¸ªäº¤å‰å¼•ç”¨åœ°å€ï¼ŒæŒ‡å‘ <code>0x00000001000065cc</code>ï¼Œè€Œè¯¥åœ°å€è½åœ¨ <code>__TEXT.__stub_helper</code> ä¸­ï¼Œä¸”è¯¥å¤„çš„ Data ä¸º <code>50000018</code>ï¼š<br><img src="a5ddcb7c/7.png" srcset="/img/loading.gif" lazyload alt="__stubs"><br>å¯¹åº”çš„æ±‡ç¼–ä»£ç ä¼šå°†æµç¨‹è½¬å‘ <code>__TEXT.__stub_helper</code> çš„å¤´éƒ¨<br><img src="a5ddcb7c/8.png" srcset="/img/loading.gif" lazyload alt="__stubs"></p><h4 id="3-TEXT-stub-helper"><a href="#3-TEXT-stub-helper" class="headerlink" title="3. __TEXT.__stub_helper"></a>3. <code>__TEXT.__stub_helper</code></h4><p><code>__TEXT.__stub_helper</code> åŒºåŸŸæ˜¯ä¸€æ®µæ±‡ç¼–ä»£ç ï¼Œè¿™æ®µä»£ç ä¸ä»…ä¼šæ‰¾åˆ°è¦è°ƒç”¨ç¬¦å·çœŸæ­£çš„åœ°å€å¹¶è·³è½¬åˆ°åœ°å€æ‰§è¡Œï¼Œè€Œä¸”ä¼šå°†è¯¥åœ°å€å†™å›å¯¹åº”çš„ <code>__DATA.__la_symbol_ptr</code>ï¼Œå®ç°â€œç¼“å­˜â€ã€‚</p><h4 id="NSLog-çš„ç»‘å®šè¿‡ç¨‹"><a href="#NSLog-çš„ç»‘å®šè¿‡ç¨‹" class="headerlink" title="NSLog çš„ç»‘å®šè¿‡ç¨‹"></a><code>NSLog</code> çš„ç»‘å®šè¿‡ç¨‹</h4><ul><li>æ–°å»ºä¸€ä¸ª <a target="_blank" rel="noopener" href="https://github.com/Navimark/MachOExploration/blob/master/HelloWorld/ViewController.m">demo</a> ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ï¼š<figure class="highlight objc"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs objc">- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;<br>  [<span class="hljs-keyword">super</span> viewDidLoad];<br>  <span class="hljs-comment">// Do any additional setup after loading the view.</span><br>  <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;1&quot;</span>);<br>  <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;2&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>åœ¨ä¸¤ä¸ª <code>NSLog</code> å¤„åˆ†åˆ«ä¸‹æ–­ç‚¹ï¼Œè®¾ç½® Debug Workflow ä¸º Always Show Disassemblyï¼Œç„¶åé€‰æ‹© arm64 çœŸæœºè¿è¡Œï¼Œå¦‚å›¾ï¼š<br><img src="a5ddcb7c/9.png" srcset="/img/loading.gif" lazyload alt="__stubs"><br>Xcode æç¤ºå½“å‰ä½ç½®ä¸º <code>symbol stub for NSLog</code></li><li>å¾—åˆ° ALSR åç§»ï¼š<code>0x102ea0000</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">(lldb) image list HelloWorld<br>  [  0] 1F21C492-D5E8-3B0B-B239-E0E691E7D64F 0x0000000102ea0000 /Users/chenzheng/Library/Developer/Xcode/DerivedData/MachOExploration-gyejyvbqloguepctiipvnexsjqsv/Build/Products/Debug-iphoneos/HelloWorld.app/HelloWorld<br></code></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œ lldb step into å‘½ä»¤<code>stepi</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">HelloWorld</span>`NSLog:<br>-&gt;  <span class="hljs-number">0x102ea6568</span> &lt;+<span class="hljs-number">0</span>&gt;: <span class="hljs-keyword">nop</span>    <br>    <span class="hljs-number">0x102ea656c</span> &lt;+<span class="hljs-number">4</span>&gt;: <span class="hljs-keyword">ldr</span>    x16, <span class="hljs-number">#0x1a9c</span>   <span class="hljs-comment">; (void *)0x0000000102ea6610</span><br>    <span class="hljs-number">0x102ea6570</span> &lt;+<span class="hljs-number">8</span>&gt;: <span class="hljs-keyword">br</span>     x16<br></code></pre></td></tr></table></figure><p>æŒ‰ä½ Control é”®ç‚¹ Step Over è¾¾åˆ° <code>ldr</code> æ‰€åœ¨è¡Œï¼Œè¯¥è¡Œå– (<code>pc + 0x1a9c</code>) å¤„çš„åœ°å€ï¼ˆç»è¿‡è®¡ç®—ä¸º <code>0x0000000102ea8008</code>ï¼‰ï¼Œå­˜å…¥ <code>x16</code>ï¼Œè¯¥åœ°å€æŒ‡å‘ <code>__DATA.__la_symbol_ptr</code> ä¸­åç§»ä¸º <code>0x0</code> çš„ä½ç½®ï¼Œç”± MachOView å¯çŸ¥è¯¥å¤„å³æ˜¯ <code>_NSLog</code> çš„ä½ç½®ï¼Œå¯¹åº”ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="a5ddcb7c/10.png" srcset="/img/loading.gif" lazyload alt="__stubs"></p><h4 id="çœŸå®åœ°å€çš„æ‰€åœ¨"><a href="#çœŸå®åœ°å€çš„æ‰€åœ¨" class="headerlink" title="çœŸå®åœ°å€çš„æ‰€åœ¨"></a>çœŸå®åœ°å€çš„æ‰€åœ¨</h4><ul><li>åœ¨ <code>0x0000000102ea6610</code> å¤„ä¸‹æ–­ç‚¹:<code>br set -a 0x0000000102ea6610</code>ï¼Œç„¶åç»§ç»­æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼š<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs armasm">-&gt;  <span class="hljs-number">0x102ea6610</span>: <span class="hljs-keyword">ldr</span>    w16, <span class="hljs-number">0x102ea6618</span><br>  <span class="hljs-number">0x102ea6614</span>: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x102ea65f8</span><br>  <span class="hljs-number">0x102ea6618</span>: udf    <span class="hljs-number">#0x0</span><br>  <span class="hljs-number">0x102ea661c</span>: <span class="hljs-keyword">ldr</span>    w16, <span class="hljs-number">0x102ea6624</span><br>  <span class="hljs-number">0x102ea6620</span>: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x102ea65f8</span><br>  <span class="hljs-number">0x102ea6624</span>: udf    <span class="hljs-number">#0xd</span><br>  <span class="hljs-number">0x102ea6628</span>: <span class="hljs-keyword">ldr</span>    w16, <span class="hljs-number">0x102ea6630</span><br>  <span class="hljs-number">0x102ea662c</span>: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x102ea65f8</span><br></code></pre></td></tr></table></figure>ç»“åˆç¬¬ä¸€è¡Œå’Œç¬¬ä¸‰è¡Œï¼Œ<code>0x102ea6610</code> å¤„çš„ <code>ldr</code> æŒ‡ä»¤å®é™…æ˜¯å–æ–‡ä»¶ <code>0x6618</code> å¤„æŒ‡ç¤ºçš„ç«‹å³æ•° <code>0x00000000</code> å­˜å…¥ <code>x16</code> ä¸­ï¼Œè¿™ä¸ª <code>0x00000000</code> æ˜¯ä¸€ä¸ªåç§»å€¼ï¼Œæè¿°çš„æ˜¯è·ç¦»Dynamic Loader Info ä¸­ Lazy Binding Info èµ·å§‹åœ°å€çš„åç§»ï¼Œä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œåç§»åä½ç½®ä¸º <code>0x0000c2a8 + 0x00000000</code><br><img src="a5ddcb7c/11.png" srcset="/img/loading.gif" lazyload alt="__stubs"><br>å…¶ä¸­ <code>dylib(1)</code> è¡¨ç¤ºè¯¥ç¬¦å·å¤„äºå½“å‰æ–‡ä»¶ç¬¬ä¸‰ä¸ª LC_LOAD_DYLIB ä¸­ï¼Œå³ <code>libSystem.B.dylib</code> ä¸­ï¼›segment(2) å’Œ offset(8) è¡¨ç¤ºå°†æ‰¾åˆ°çš„çœŸå®åœ°å€å†™å…¥å½“å‰æ–‡ä»¶æ¶æ„çš„ç¬¬ 2 ä¸ª segment åç§»ä¸º 8 çš„åœ°æ–¹ã€‚ä» MachOView ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒä¸ª segment å³ä¸º __DATAï¼Œåç§» 8 çš„ä½ç½®åˆšå¥½æ˜¯ <code>_NSLog</code> çš„ç¬¦å·<div class="group-image-container"><div class="group-image-row"></div><div class="group-image-row"><div class="group-image-wrap"><img src="a5ddcb7c/12.png" srcset="/img/loading.gif" lazyload alt="NSLog1"></div><div class="group-image-wrap"><img src="a5ddcb7c/13.png" srcset="/img/loading.gif" lazyload alt="NSLog2"></div><div class="group-image-wrap"><img src="a5ddcb7c/14.png" srcset="/img/loading.gif" lazyload alt="NSLog3"></div></div></div></li></ul></li><li><p>ç»‘å®šä¸æ‰§è¡Œ<br>è®¾ç½®æ–­ç‚¹ <code>br set -a 0x102ea65f8</code> ç»§ç»­æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-number">0x102ea65f8</span>: <span class="hljs-keyword">adr</span>    x17, <span class="hljs-number">#0x2fb8</span>  <span class="hljs-comment">; _dyld_private</span><br><span class="hljs-number">0x102ea65fc</span>: <span class="hljs-keyword">nop</span>    <br><span class="hljs-number">0x102ea6600</span>: stp    x16, x17, [<span class="hljs-built_in">sp</span>, #-<span class="hljs-number">0x10</span>]!<br><span class="hljs-number">0x102ea6604</span>: <span class="hljs-keyword">nop</span>    <br><span class="hljs-number">0x102ea6608</span>: <span class="hljs-keyword">ldr</span>    x16, <span class="hljs-number">#0x19f8</span>  <span class="hljs-comment">; (void *)0x00000001b51bc80c: dyld_stub_binder</span><br><span class="hljs-number">0x102ea660c</span>: <span class="hljs-keyword">br</span>     x16<br><span class="hljs-number">0x102ea6610</span>: <span class="hljs-keyword">ldr</span>    w16, <span class="hljs-number">0x102ea6618</span><br><span class="hljs-number">0x102ea6614</span>: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x102ea65f8</span><br></code></pre></td></tr></table></figure><p><code>dyld_stub_binder</code> å’ŒçœŸå®åœ°å€æŸ¥æ‰¾æœ‰å…³ï¼Œåœ¨æ­¤å¤„ä¸‹æ–­ç‚¹ï¼š<code>br set -a 0x00000001b51bc80c</code> åç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥åˆ° <code>dyld</code> å†…éƒ¨ï¼Œå•æ­¥æ‰§è¡Œåˆ° <code>_dyld_fast_stub_entry</code> æ‰€åœ¨è¡Œï¼Œå¦‚å›¾ï¼š<br><img src="a5ddcb7c/15.png" srcset="/img/loading.gif" lazyload alt="NSLog1"></p><p>åœ¨è¿™ä¸€è¡Œçš„å‰ä¸¤è¡Œ:</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-number">0x1b51bc83c</span> &lt;+<span class="hljs-number">48</span>&gt;:  <span class="hljs-keyword">ldr</span> x0, [x29, <span class="hljs-number">#0x18</span>] <br><span class="hljs-number">0x1b51bc840</span> &lt;+<span class="hljs-number">52</span>&gt;:  <span class="hljs-keyword">ldr</span> x1, [x29, <span class="hljs-number">#0x10</span>]<br></code></pre></td></tr></table></figure><p>å°† <code>x29</code> åˆ†åˆ«åç§» <code>0x18</code> å’Œ <code>0x10</code> å¤„çš„åœ°å€å¯¹åº”çš„å€¼å–å‡ºæ¥æ”¾åˆ° <code>x0</code>ã€<code>x1</code>ï¼Œä½œä¸ºå‚æ•°ä¼ ç»™äº† <code>_dyld_fast_stub_entry</code>ï¼Œ<code>_dyld_fast_stub_entry</code> ä¸­å°†å®Œæˆç¬¦å·åœ°å€çš„æŸ¥æ‰¾ã€‚<code>x1</code> ä¸­å°±æ˜¯ä¸Šè¿°æåˆ°çš„åç§»é‡, è€Œ <code>x0</code> æ˜¯ä¸€ä¸ª<code>_dyld_private</code>æŒ‡é’ˆ:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">(lldb) register <span class="hljs-built_in">read</span> x1<br>      x1 = 0x0000000000000000<br>(lldb) register <span class="hljs-built_in">read</span> x0<br>      x0 = 0x0000000102ea95b0  _dyld_private<br></code></pre></td></tr></table></figure></li><li><code>_dyld_fast_stub_entry</code><br>è¿™æ˜¯ <code>dyld</code> ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¸‹è½½ä¸€å¥—å’Œç³»ç»Ÿä¸­æ­£åœ¨ä½¿ç”¨çš„ <code>dyld</code> æœ€æ¥è¿‘çš„æºç ï¼Œå°è¯•åˆ†æå…¶åŠŸèƒ½ã€‚<br>åœ¨ lldb ä¸­æ‰§è¡Œ <code>image list dyld</code>ï¼Œå¾—åˆ° <code>dyld</code> çš„è·¯å¾„<code>/Users/chenzheng/Library/Developer/Xcode/iOS DeviceSupport/12.4 (16G77)/Symbols/usr/lib/dyld</code>ï¼Œå°†å…¶æ‹–å…¥åˆ° MachOView ä¸­ï¼Œå®šä½åˆ° <code>LC_SOURCE_VERSION</code>ï¼Œçœ‹åˆ° Version ä¸º 650.3.4ï¼Œå¯æƒœ <a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/dyld/">dyld æºç é¡µé¢</a>å¹¶æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸‹è½½äº† 655 ç‰ˆæœ¬ã€‚æ‰“å¼€ dyld å·¥ç¨‹åå®šä½åˆ° <code>_dyld_fast_stub_entry</code>:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> __i386__ || __x86_64__ || __arm__ || __arm64__</span><br>__attribute__((visibility(<span class="hljs-string">&quot;hidden&quot;</span>))) <br><span class="hljs-type">void</span>* _dyld_fast_stub_entry(<span class="hljs-type">void</span>* loadercache, <span class="hljs-type">long</span> lazyinfo)<br>&#123;<br>  DYLD_NO_LOCK_THIS_BLOCK;<br>    <span class="hljs-type">static</span> <span class="hljs-type">void</span>* (*p)(<span class="hljs-type">void</span>*, <span class="hljs-type">long</span>) = <span class="hljs-literal">NULL</span>;<br>  <br>  <span class="hljs-keyword">if</span>(p == <span class="hljs-literal">NULL</span>)<br>      <span class="hljs-comment">// å¦‚æœç¼“å­˜ä½ç½®ä¸ºç©ºï¼Œä»å…¨å±€çš„ `å‡½æ•°å-å‡½æ•°æŒ‡é’ˆ` æ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”çš„</span><br>      <span class="hljs-comment">// å‡½æ•°æŒ‡é’ˆ ((void*)dyld::fastBindLazySymbol)ï¼Œç„¶åå°†å½¢å‚é€ä¼ è¿‡å»å¹¶æ‰§è¡Œ</span><br>      <span class="hljs-comment">// ç„¶åè¿”å›æ‰§è¡Œçš„ç»“æœï¼Œæ­¤ç»“æœåº”è¯¥å°±æ˜¯ç¬¦å·å¯¹åº”çš„çœŸå®åœ°å€</span><br>      _dyld_func_lookup(<span class="hljs-string">&quot;__dyld_fast_stub_entry&quot;</span>, (<span class="hljs-type">void</span>**)&amp;p);<br>  <span class="hljs-keyword">return</span> p(loadercache, lazyinfo);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>å¥½å¥‡ä¸€ä¸‹ <code>dyld::fastBindLazySymbol</code> çš„å®ç°ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">fastBindLazySymbol</span><span class="hljs-params">(ImageLoader** imageLoaderCache, \</span><br><span class="hljs-params"> <span class="hljs-type">uintptr_t</span> lazyBindingInfoOffset)</span><br>&#123;<br>  <span class="hljs-type">uintptr_t</span> result = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// get image </span><br>  <span class="hljs-keyword">if</span> ( *imageLoaderCache == <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// save in cache</span><br>    *imageLoaderCache = dyld::findMappedRange((<span class="hljs-type">uintptr_t</span>)imageLoaderCache);<br>    <span class="hljs-keyword">if</span> ( *imageLoaderCache == <span class="hljs-literal">NULL</span> ) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> SUPPORT_ACCELERATE_TABLES</span><br>    <span class="hljs-keyword">if</span> ( sAllCacheImagesProxy != <span class="hljs-literal">NULL</span> ) &#123;<br>      <span class="hljs-type">const</span> mach_header* mh;<br>      <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path;<br>      <span class="hljs-type">unsigned</span> index;<br>      <span class="hljs-keyword">if</span> ( sAllCacheImagesProxy-&gt;addressInCache(imageLoaderCache, &amp;mh, \<br>        &amp;path, &amp;index) ) &#123;<br>        result = sAllCacheImagesProxy-&gt;bindLazy(lazyBindingInfoOffset, \<br>         gLinkContext, mh, index);<br>        <span class="hljs-keyword">if</span> ( result == <span class="hljs-number">0</span> ) &#123;<br>          halt(<span class="hljs-string">&quot;dyld: lazy symbol binding failed for image in dyld shared\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>      &#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-type">const</span> <span class="hljs-type">char</span>* message = <span class="hljs-string">&quot;fast lazy binding from unknown image&quot;</span>;<br>      dyld::<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;dyld: %s\n&quot;</span>, message);<br>      halt(message);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-comment">// bind lazy pointer and return it</span><br>  try &#123;<br>    result = (*imageLoaderCache)-&gt;doBindFastLazySymbol( \ <br>            (<span class="hljs-type">uint32_t</span>)lazyBindingInfoOffset, gLinkContext, \<br>            (dyld::gLibSystemHelpers != <span class="hljs-literal">NULL</span>) ? \<br>            dyld::gLibSystemHelpers-&gt;acquireGlobalDyldLock : <span class="hljs-literal">NULL</span>,<br>						(dyld::gLibSystemHelpers != <span class="hljs-literal">NULL</span>) ? \<br>              dyld::gLibSystemHelpers-&gt;releaseGlobalDyldLock : <span class="hljs-literal">NULL</span>);<br>  &#125;<br>  catch (<span class="hljs-type">const</span> <span class="hljs-type">char</span>* message) &#123;<br>    dyld::<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;dyld: lazy symbol binding failed: %s\n&quot;</span>, message);<br>    halt(message);<br>  &#125;<br><br>  <span class="hljs-comment">// return target address to glue which jumps to it with real parameters restored</span><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>å¤§è‡´æ˜¯æ ¹æ®ä¼ å…¥çš„ <code>lazyBindingInfoOffset</code> å’Œ <code>gLinkContext</code> æ‰¾åˆ°çœŸå®çš„åœ°å€ï¼Œç„¶åè¿”å›ã€‚</li><li><p>å†å•æ­¥ä¸€æ¬¡æ‰§è¡Œå®Œ <code>_dyld_fast_stub_entry</code>ï¼Œå¾—åˆ°å…¶è¿”å›å€¼ï¼ˆå­˜åœ¨åœ¨x0ä¸­ï¼‰ï¼Œæ‰“å° x0 ï¼Œå¾—åˆ°çš„ <code>0x00000001b61d7620</code> æ­£æ˜¯ <code>NSLog</code> åœ¨ Foundation æ¡†æ¶ä¸­çš„åœ°å€ï¼š<br><img src="a5ddcb7c/16.png" srcset="/img/loading.gif" lazyload alt="NSLog1"></p></li><li><p>ç¬¬äºŒæ¬¡æ‰§è¡Œ<br>å•æ­¥æ‰§è¡Œï¼Œåº”è¯¥ä¼šåœåœ¨ç¬¬äºŒä¸ª <code>NSLog</code> çš„åœ°æ–¹ï¼š<br><img src="a5ddcb7c/17.png" srcset="/img/loading.gif" lazyload alt="NSLog1"><br>è®¾ç½®æ–­ç‚¹ <code>br set -a 0x102ea6568</code>ï¼Œç„¶åæ‰§è¡Œï¼Œåœ¨æ–­ç‚¹ä½ç½®å·²ç»æœ‰æç¤ºï¼Œå­˜å…¥ <code>x16</code> çš„åœ°å€å·²ç»æ˜¯ä¸Šè¿° <code>NSLog</code> çš„åœ°å€ <code>0x00000001b61d7620</code>ï¼Œç»è¿‡éªŒè¯ï¼Œ<code>__DATA.__la_symbol_ptr</code> åç§» <code>0x00</code> å¤„çš„å€¼å·²ç»è¢«èµ‹å€¼ä¸ºäº† <code>0x00000001b61d7620</code><br><img src="a5ddcb7c/18.png" srcset="/img/loading.gif" lazyload alt="NSLog1"></p></li></ul><h4 id="dyld-stub-binderï¼Ÿ"><a href="#dyld-stub-binderï¼Ÿ" class="headerlink" title="dyld_stub_binderï¼Ÿ"></a><code>dyld_stub_binder</code>ï¼Ÿ</h4><p><code>__TEXT.__stub_helper</code> ä¸­æœ¬æ˜¯ç”¨æ¥å¸®åŠ©å¤„ç†ç¬¦å·çš„å»¶è¿Ÿç»‘å®šçš„ä¸€æ®µä»£ç ï¼Œé‡Œé¢å¼•ç”¨äº†åŒæ ·ä¸åœ¨å½“å‰ Mach-O ä¸­çš„ç¬¦å· <code>dyld_stub_binder</code>ï¼Œå¥½åƒæœ‰é—®é¢˜ğŸ¤”<br>å…¶å® <code>dyld_stub_binder</code> å­˜åœ¨äº <code>__DATA.__got</code> åŒºåŸŸï¼Œæ˜¯éå»¶è¿Ÿç»‘å®šçš„ç¬¦å·ï¼Œå®ƒåœ¨ Mach-O åŠ è½½å®Œæˆåç«‹å³å¯ç”¨ï¼Œå¯ä»¥ç”¨æ¥è¾…åŠ©å®šä½å»¶è¿Ÿç»‘å®šç¬¦å·çš„åœ°å€ã€‚</p><h3 id="æµç¨‹æ€»ç»“"><a href="#æµç¨‹æ€»ç»“" class="headerlink" title="æµç¨‹æ€»ç»“"></a>æµç¨‹æ€»ç»“</h3><p>ä¸Šè¿° <code>viewDidLoad</code> å¯¹åº”çš„æ±‡ç¼–ä»£ç :<br><img src="a5ddcb7c/19.png" srcset="/img/loading.gif" lazyload alt="NSLog1"><br>ç¬¬ä¸€æ¬¡ <code>bl imp_stubs_NSLog</code> æ—¶å°†è·³è½¬åˆ° <code>NSLog</code> çš„æ¡©ç‚¹ï¼Œè¿™ä¸€æ®µæ±‡ç¼–ä»£ç å°†ä» <code>__DATA.__la_symbol_ptr</code> ä¸­è¯»å–åœ°å€å¹¶è·³è½¬æ‰§è¡Œï¼Œè€Œ <code>__DATA.__la_symbol_ptr</code> ä¸­æ­¤æ—¶çš„åœ°å€æŒ‡å‘ <code>__TEXT.__stub_helper</code> å¹¶æœ€ç»ˆè¢«å¼•å¯¼åˆ° <code>__TEXT.__stub_helper</code> çš„å¤´éƒ¨æ‰§è¡Œï¼›åœ¨ <code>__TEXT.__stub_helper</code> ä¸­è°ƒç”¨éå»¶è¿Ÿç»‘å®šçš„ <code>dyld_stub_binder</code> ï¼Œåœ¨å…¶ä¸­é€šè¿‡ <code>_dyld_fast_stub_entry</code> æ‹¿åˆ°çœŸå®çš„åœ°å€ï¼Œè°ƒç”¨ <code>_dyld_fast_stub_entry</code> æ—¶ä¼ å…¥äº†ä» Dynamic Loader Info ä¸­å–åˆ°çš„å½“å‰å¾…ç»‘å®šç¬¦å·çš„ Lazy Binding Info ï¼Œä»¥ä¾¿åœ¨æ‰¾åˆ°çœŸå®åœ°å€åèƒ½å¤Ÿå†™å› <code>__DATA.__la_symbol_ptr</code> ä¸­ï¼Œä¸‹æ¬¡ <code>bl imp_stubs_NSLog</code> æ—¶å°†ç›´æ¥è°ƒç”¨</p><p>å»¶è¿Ÿç»‘å®šæŠ€æœ¯å¾ˆå¥½åœ°å¤„ç†å¥½äº†ä»£ç å¤ç”¨å’Œä½¿ç”¨æ•ˆç‡é—®é¢˜ï¼Œæ•´ä¸ªè¿‡ç¨‹åªæœ‰åœ¨è‡ªå·±äº²è‡ªåŠ¨æ‰‹è·Ÿè¿›ä¸€ç•ªæ‰ä¼šæœ‰æ·±åˆ»çš„ç†è§£</p><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2f4a5f74ac7a">ARM64 æ±‡ç¼–â€”â€”å¯„å­˜å™¨å’ŒæŒ‡ä»¤</a> <a href="#fnref:1" rev="footnote" class="footnote-backref">â†©</a></span></span></li></ol></div></section></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Mach-O/">Mach-O</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E5%BA%95%E5%B1%82/">åº•å±‚</a> <a class="hover-with-bg" href="/tags/Mach-O/">Mach-O</a> <a class="hover-with-bg" href="/tags/%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F/">åŠ è½½æ–¹å¼</a> <a class="hover-with-bg" href="/tags/lldb/">lldb</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/349e475.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">fishhook åŸç†åŠå…¶æºç é˜…è¯»</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/posts/f5d9b671.html"><span class="hidden-mobile">ç»™ GitHub Pages åšå®¢ç»‘å®šå…è´¹çš„ä¸ªäººåŸŸå</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js",(function(){var i=Object.assign({appId:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appKey:"Y6tve5P6QYMvu13i6cXcL8ly",path:"window.location.pathname",placeholder:"è¯´ç‚¹ä»€ä¹ˆ",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!1,serverURLs:null,emojiCDN:null,emojiMaps:null,enableQQ:!1,appid:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appkey:"Y6tve5P6QYMvu13i6cXcL8ly"},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><span id="cnzz_stat_icon_1278975811" style="display:none"></span></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?15186363";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154660540-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script defer src="//s4.cnzz.com/z_stat.php?id=1278975811&show=pic" type="text/javascript"></script><script src="/js/boot.js"></script></body></html>