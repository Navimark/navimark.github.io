<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Navimark"><meta name="keywords" content="汇编,汇编入门,寄存器,CPU,page,switch,if"><meta name="description" content="本文将对高级语言中常见的基础语句块进行汇编代码调试，如全局变量、局部变量、if &#x2F; for &#x2F; while 语句、switch、指针类型等，以加深印象和理解，方便在查看二进制反汇编代码时能快速识别并准确地“翻译”为高级语言伪代码。  全局变量 &amp; 局部变量下面代码中，全局变量和局部变量是如何取值并参与运算的呢？12345678int globalVal &#x3D; 0xabcdef;int su"><meta property="og:type" content="article"><meta property="og:title" content="逆向学习笔记 - 部分场景的 ARM64 汇编指令"><meta property="og:url" content="https://navimark.github.io/posts/9d246b3e.html"><meta property="og:site_name" content="子非鱼"><meta property="og:description" content="本文将对高级语言中常见的基础语句块进行汇编代码调试，如全局变量、局部变量、if &#x2F; for &#x2F; while 语句、switch、指针类型等，以加深印象和理解，方便在查看二进制反汇编代码时能快速识别并准确地“翻译”为高级语言伪代码。  全局变量 &amp; 局部变量下面代码中，全局变量和局部变量是如何取值并参与运算的呢？12345678int globalVal &#x3D; 0xabcdef;int su"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://navimark.github.io/img/PostIndexImg/202103/Assembly-01.png"><meta property="article:published_time" content="2021-04-04T14:05:01.000Z"><meta property="article:modified_time" content="2022-02-23T11:00:40.405Z"><meta property="article:author" content="Navimark"><meta property="article:tag" content="汇编"><meta property="article:tag" content="底层"><meta property="article:tag" content="笔记"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://navimark.github.io/img/PostIndexImg/202103/Assembly-01.png"><title>逆向学习笔记 - 部分场景的 ARM64 汇编指令 - 子非鱼</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/xcode.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"navimark.github.io",root:"/",version:"1.8.14",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:6},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:15186363,google:"UA-154660540-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:1278975811,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body><header style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>子非鱼</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="逆向学习笔记 - 部分场景的 ARM64 汇编指令"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-04-04 22:05" pubdate>2021年4月4日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 10k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 86 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">逆向学习笔记 - 部分场景的 ARM64 汇编指令</h1><div class="markdown-body"><blockquote><p>本文将对高级语言中常见的基础语句块进行汇编代码调试，如全局变量、局部变量、<code>if</code> / <code>for</code> / <code>while</code> 语句、<code>switch</code>、指针类型等，以加深印象和理解，方便在查看二进制反汇编代码时能快速识别并准确地“翻译”为高级语言伪代码。</p></blockquote><h1 id="全局变量-amp-局部变量"><a href="#全局变量-amp-局部变量" class="headerlink" title="全局变量 &amp; 局部变量"></a>全局变量 &amp; 局部变量</h1><p>下面代码中，全局变量和局部变量是如何取值并参与运算的呢？<br></p><figure class="highlight objc"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">int</span> globalVal = <span class="hljs-number">0xabcdef</span>;<br><span class="hljs-keyword">int</span> sumV(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b) &#123;<br>    <span class="hljs-keyword">int</span> tempG = globalVal;<br>    <span class="hljs-built_in">NSArray</span> *arr = [<span class="hljs-built_in">NSArray</span> new];<br>    <span class="hljs-keyword">int</span> c = <span class="hljs-number">0x11</span>;<br>    <span class="hljs-keyword">int</span> d = <span class="hljs-number">0x14</span>;<br>    <span class="hljs-keyword">return</span> a + b + c + tempG;<br>&#125;<br></code></pre></td></tr></table></figure><br>在 <code>main</code> 中调用 <code>int res = sumV(0x1, 0x2);</code>，在 <code>sumV</code> 首行添加断点，设置 Xode 展示汇编指令，以默认的 Debug 优化级别运行，如下：<p></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs armasm">    <span class="hljs-number">0x100dc206c</span> &lt;+<span class="hljs-number">0</span>&gt;:   <span class="hljs-keyword">sub</span>    <span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x40</span>    <span class="hljs-comment">; =0x40 </span><br>    <span class="hljs-number">0x100dc2070</span> &lt;+<span class="hljs-number">4</span>&gt;:   stp    x29, x30, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x30</span>]<br>    <span class="hljs-number">0x100dc2074</span> &lt;+<span class="hljs-number">8</span>&gt;:   <span class="hljs-keyword">add</span>    x29, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x30</span>   <span class="hljs-comment">; =0x30 </span><br>    <span class="hljs-number">0x100dc2078</span> &lt;+<span class="hljs-number">12</span>&gt;:  stur   w0, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x100dc207c</span> &lt;+<span class="hljs-number">16</span>&gt;:  stur   w1, [x29, #-<span class="hljs-number">0x8</span>]<br>    <span class="hljs-number">0x100dc2080</span> &lt;+<span class="hljs-number">20</span>&gt;:  <span class="hljs-keyword">adrp</span>   x8, <span class="hljs-number">3</span><br>    <span class="hljs-number">0x100dc2084</span> &lt;+<span class="hljs-number">24</span>&gt;:  <span class="hljs-keyword">add</span>    x8, x8, <span class="hljs-number">#0x6a0</span>   <span class="hljs-comment">; =0x6a0 </span><br>-&gt;  <span class="hljs-number">0x100dc2088</span> &lt;+<span class="hljs-number">28</span>&gt;:  <span class="hljs-keyword">ldr</span>    w9, [x8]<br>    <span class="hljs-number">0x100dc208c</span> &lt;+<span class="hljs-number">32</span>&gt;:  stur   w9, [x29, #-<span class="hljs-number">0xc</span>]<br>    <span class="hljs-number">0x100dc2090</span> &lt;+<span class="hljs-number">36</span>&gt;:  <span class="hljs-keyword">adrp</span>   x8, <span class="hljs-number">3</span><br>    <span class="hljs-number">0x100dc2094</span> &lt;+<span class="hljs-number">40</span>&gt;:  <span class="hljs-keyword">add</span>    x8, x8, <span class="hljs-number">#0x4c8</span>   <span class="hljs-comment">; =0x4c8 </span><br>    <span class="hljs-number">0x100dc2098</span> &lt;+<span class="hljs-number">44</span>&gt;:  <span class="hljs-keyword">ldr</span>    x0, [x8]<br>    <span class="hljs-number">0x100dc209c</span> &lt;+<span class="hljs-number">48</span>&gt;:  <span class="hljs-keyword">adrp</span>   x8, <span class="hljs-number">3</span><br>    <span class="hljs-number">0x100dc20a0</span> &lt;+<span class="hljs-number">52</span>&gt;:  <span class="hljs-keyword">add</span>    x8, x8, <span class="hljs-number">#0x4a8</span>   <span class="hljs-comment">; =0x4a8 </span><br>    <span class="hljs-number">0x100dc20a4</span> &lt;+<span class="hljs-number">56</span>&gt;:  <span class="hljs-keyword">ldr</span>    x1, [x8]<br>    <span class="hljs-number">0x100dc20a8</span> &lt;+<span class="hljs-number">60</span>&gt;:  <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100dc24f4</span>  <span class="hljs-comment">;  objc_msgSend</span><br>    <span class="hljs-number">0x100dc20ac</span> &lt;+<span class="hljs-number">64</span>&gt;:  <span class="hljs-keyword">add</span>    x8, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x18</span>    <span class="hljs-comment">; =0x18 </span><br>    <span class="hljs-number">0x100dc20b0</span> &lt;+<span class="hljs-number">68</span>&gt;:  <span class="hljs-keyword">str</span>    x0, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x18</span>]<br>    <span class="hljs-number">0x100dc20b4</span> &lt;+<span class="hljs-number">72</span>&gt;:  <span class="hljs-keyword">mov</span>    w9, <span class="hljs-number">#0x11</span><br>    <span class="hljs-number">0x100dc20b8</span> &lt;+<span class="hljs-number">76</span>&gt;:  <span class="hljs-keyword">str</span>    w9, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x14</span>]<br>    <span class="hljs-number">0x100dc20bc</span> &lt;+<span class="hljs-number">80</span>&gt;:  <span class="hljs-keyword">mov</span>    w9, <span class="hljs-number">#0x14</span><br>    <span class="hljs-number">0x100dc20c0</span> &lt;+<span class="hljs-number">84</span>&gt;:  <span class="hljs-keyword">str</span>    w9, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x10</span>]<br>    <span class="hljs-number">0x100dc20c4</span> &lt;+<span class="hljs-number">88</span>&gt;:  ldur   w9, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x100dc20c8</span> &lt;+<span class="hljs-number">92</span>&gt;:  ldur   w10, [x29, #-<span class="hljs-number">0x8</span>]<br>    <span class="hljs-number">0x100dc20cc</span> &lt;+<span class="hljs-number">96</span>&gt;:  <span class="hljs-keyword">add</span>    w9, w9, w10<br>    <span class="hljs-number">0x100dc20d0</span> &lt;+<span class="hljs-number">100</span>&gt;: <span class="hljs-keyword">ldr</span>    w10, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x14</span>]<br>    <span class="hljs-number">0x100dc20d4</span> &lt;+<span class="hljs-number">104</span>&gt;: <span class="hljs-keyword">add</span>    w9, w9, w10<br>    <span class="hljs-number">0x100dc20d8</span> &lt;+<span class="hljs-number">108</span>&gt;: ldur   w10, [x29, #-<span class="hljs-number">0xc</span>]<br>    <span class="hljs-number">0x100dc20dc</span> &lt;+<span class="hljs-number">112</span>&gt;: <span class="hljs-keyword">add</span>    w0, w9, w10<br>    <span class="hljs-number">0x100dc20e0</span> &lt;+<span class="hljs-number">116</span>&gt;: <span class="hljs-keyword">str</span>    w0, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0xc</span>]<br>    <span class="hljs-number">0x100dc20e4</span> &lt;+<span class="hljs-number">120</span>&gt;: <span class="hljs-keyword">mov</span>    x0, x8<br>    <span class="hljs-number">0x100dc20e8</span> &lt;+<span class="hljs-number">124</span>&gt;: <span class="hljs-keyword">mov</span>    x8, <span class="hljs-number">#0x0</span><br>    <span class="hljs-number">0x100dc20ec</span> &lt;+<span class="hljs-number">128</span>&gt;: <span class="hljs-keyword">mov</span>    x1, x8<br>    <span class="hljs-number">0x100dc20f0</span> &lt;+<span class="hljs-number">132</span>&gt;: <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100dc2524</span>  <span class="hljs-comment">;  objc_storeStrong</span><br>    <span class="hljs-number">0x100dc20f4</span> &lt;+<span class="hljs-number">136</span>&gt;: <span class="hljs-keyword">ldr</span>    w0, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0xc</span>]<br>    <span class="hljs-number">0x100dc20f8</span> &lt;+<span class="hljs-number">140</span>&gt;: ldp    x29, x30, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x30</span>]<br>    <span class="hljs-number">0x100dc20fc</span> &lt;+<span class="hljs-number">144</span>&gt;: <span class="hljs-keyword">add</span>    <span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x40</span>    <span class="hljs-comment">; =0x40 </span><br>    <span class="hljs-number">0x100dc2100</span> &lt;+<span class="hljs-number">148</span>&gt;: ret    <br></code></pre></td></tr></table></figure><ol><li>前三行开辟栈空间 -&gt; 保存上一个函数栈底信息和自己的返回地址 -&gt; 保存自己的栈底地址</li><li>第 4 行的 <code>stur</code> 等同于 <code>str</code>，但操作数为负数，结果是将两个形参放到栈底开始的位置</li><li><code>adrp x8, 3</code>：<code>adrp</code> 以页为单位的大范围的地址读取指令。将 3 左移 12 位得到的数与清空了低 12 位的 pc 寄存器的值相加，结果放入 x8 中，这是某个 Page 的起始地址，配合接下来的偏移操作 <code>add x8, x8, #0x6a0</code>，x8 中存放的是一个特定的地址。如果基址偏移为 <code>0x100dbc000</code>，可以计算出来 x8 中的地址在二进制中的偏移为：<code>0x100dc2000 + (3 &lt;&lt; 12) + 0x6a0 - 0x100dbc000 = 0x00000000000096a0</code>，如下图，高 8 位即为 <code>globalVal</code> 的值：<img src="9d246b3e/1.png" srcset="/img/loading.gif" lazyload alt=""> 接下来将它存到了栈底偏移 <code>0xc</code> 处</li><li>第 16 行是一个 <code>objc_msgSend</code> 调用，上面分别通过 <code>adrp</code> 指令准备了参数 x0 和 x1，同上，计算可知它们的值分别来自于二进制文件偏移量 <code>0x00000000000094c8</code> 和 <code>0x00000000000094a8</code> 处，根据 <code>objc_msgSend</code> 调用规则，x0、x1 分别是 <code>NSArray.class</code> 和 <code>new</code>，接下来将返回值存到了栈顶偏移 <code>0x18</code> 处:<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="9d246b3e/2.png" srcset="/img/loading.gif" lazyload alt=""></div><div class="group-image-wrap"><img src="9d246b3e/3.png" srcset="/img/loading.gif" lazyload alt=""></div></div></div></li><li>接下来是两个基本类型的临时变量，是立即数通过寄存器中转存到了栈空间中，等到需要做加法运算时，再取到寄存器中做运算</li><li>最后 4 行将返回值存入 x0 ，恢复主调函数调用环境退栈并 <code>ret</code></li><li>在函数即将退栈时，第 34 行以 x8 和 <code>nil</code> 为形参调用了 <code>objc_storeStrong</code>，x8 是 <code>arr</code> 变量的指针，目的是在离开作用域时对指针置空，引用计数 -1，以期待下一个 RunLoop 时实例对象的内存能被 AutoReleasePool 自动释放。<code>objc_storeStrong</code> 的实现：<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">void</span> objc_storeStrong(<span class="hljs-keyword">id</span> *location, <span class="hljs-keyword">id</span> obj)<br>&#123;<br>    <span class="hljs-keyword">id</span> prev = *location;<br>    <span class="hljs-keyword">if</span> (obj == prev) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    objc_retain(obj);<br>    *location = obj;<br>    objc_release(prev);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li>全局变量存放于数据区，和代码区距离较远，使用 <code>adrp</code> 来加载</li><li>局部变量如果是基本类型，将会以立即数的形式加载；如果是对象类型，将加载指向堆区的指针</li><li>由于 <code>NASrray</code> 来自于动态库，其地址（或者说偏移值）在二进制 rebase 阶段才会被决定，所以上图中只能展示为 <code>0x0</code></li></ul><h1 id="条件、循环语句"><a href="#条件、循环语句" class="headerlink" title="条件、循环语句"></a>条件、循环语句</h1><p><code>for</code>、<code>if</code>、<code>while</code>、<code>do-while</code> 语句的汇编相差不大。参考以下代码：<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">looptest</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0xab</span>;i &lt; <span class="hljs-number">0xffff</span>;i ++) &#123;<br>        <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0xad</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;enough!\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">0xff</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Go on\n&quot;</span>);<br>        i ++;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><br>按上述方法编译成汇编得到：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs armasm">    <span class="hljs-number">0x1008e6064</span> &lt;+<span class="hljs-number">0</span>&gt;:   <span class="hljs-keyword">sub</span>    <span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x20</span>    <span class="hljs-comment">; =0x20 </span><br>    <span class="hljs-number">0x1008e6068</span> &lt;+<span class="hljs-number">4</span>&gt;:   stp    x29, x30, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x10</span>]<br>    <span class="hljs-number">0x1008e606c</span> &lt;+<span class="hljs-number">8</span>&gt;:   <span class="hljs-keyword">add</span>    x29, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x10</span>   <span class="hljs-comment">; =0x10 </span><br>    <span class="hljs-number">0x1008e6070</span> &lt;+<span class="hljs-number">12</span>&gt;:  <span class="hljs-keyword">mov</span>    w8, <span class="hljs-number">#0xab</span><br>    <span class="hljs-number">0x1008e6074</span> &lt;+<span class="hljs-number">16</span>&gt;:  stur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e6078</span> &lt;+<span class="hljs-number">20</span>&gt;:  ldur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e607c</span> &lt;+<span class="hljs-number">24</span>&gt;:  <span class="hljs-keyword">mov</span>    w9, <span class="hljs-number">#0xffff</span><br>    <span class="hljs-number">0x1008e6080</span> &lt;+<span class="hljs-number">28</span>&gt;:  <span class="hljs-keyword">cmp</span>    w8, w9<br>    <span class="hljs-number">0x1008e6084</span> &lt;+<span class="hljs-number">32</span>&gt;:  b.ge   <span class="hljs-number">0x1008e60b4</span>  <span class="hljs-comment">; &lt;+80&gt; at main.m:29:12</span><br>    <span class="hljs-number">0x1008e6088</span> &lt;+<span class="hljs-number">36</span>&gt;:  ldur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e608c</span> &lt;+<span class="hljs-number">40</span>&gt;:  <span class="hljs-keyword">cmp</span>    w8, <span class="hljs-number">#0xad</span>    <span class="hljs-comment">; =0xad </span><br>    <span class="hljs-number">0x1008e6090</span> &lt;+<span class="hljs-number">44</span>&gt;:  b.le   <span class="hljs-number">0x1008e60a4</span>  <span class="hljs-comment">; &lt;+64&gt; at main.m:23:31</span><br>    <span class="hljs-number">0x1008e6094</span> &lt;+<span class="hljs-number">48</span>&gt;:  <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">0</span><br>    <span class="hljs-number">0x1008e6098</span> &lt;+<span class="hljs-number">52</span>&gt;:  <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x66a</span>   <span class="hljs-comment">; =0x66a </span><br>-&gt;  <span class="hljs-number">0x1008e609c</span> &lt;+<span class="hljs-number">56</span>&gt;:  <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x1008e6514</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x1008e60a0</span> &lt;+<span class="hljs-number">60</span>&gt;:  <span class="hljs-keyword">b</span>      <span class="hljs-number">0x1008e60b4</span>  <span class="hljs-comment">; &lt;+80&gt; at main.m:29:12</span><br>    <span class="hljs-number">0x1008e60a4</span> &lt;+<span class="hljs-number">64</span>&gt;:  ldur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e60a8</span> &lt;+<span class="hljs-number">68</span>&gt;:  <span class="hljs-keyword">add</span>    w8, w8, <span class="hljs-number">#0x1</span> <span class="hljs-comment">; =0x1 </span><br>    <span class="hljs-number">0x1008e60ac</span> &lt;+<span class="hljs-number">72</span>&gt;:  stur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e60b0</span> &lt;+<span class="hljs-number">76</span>&gt;:  <span class="hljs-keyword">b</span>      <span class="hljs-number">0x1008e6078</span>  <span class="hljs-comment">; &lt;+20&gt; at main.m:23:18</span><br>    <span class="hljs-number">0x1008e60b4</span> &lt;+<span class="hljs-number">80</span>&gt;:  ldur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e60b8</span> &lt;+<span class="hljs-number">84</span>&gt;:  <span class="hljs-keyword">cmp</span>    w8, <span class="hljs-number">#0xff</span>    <span class="hljs-comment">; =0xff </span><br>    <span class="hljs-number">0x1008e60bc</span> &lt;+<span class="hljs-number">88</span>&gt;:  b.ge   <span class="hljs-number">0x1008e60dc</span>  <span class="hljs-comment">; &lt;+120&gt; at main.m:33:1</span><br>    <span class="hljs-number">0x1008e60c0</span> &lt;+<span class="hljs-number">92</span>&gt;:  <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">0</span><br>    <span class="hljs-number">0x1008e60c4</span> &lt;+<span class="hljs-number">96</span>&gt;:  <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x673</span>   <span class="hljs-comment">; =0x673 </span><br>    <span class="hljs-number">0x1008e60c8</span> &lt;+<span class="hljs-number">100</span>&gt;: <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x1008e6514</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x1008e60cc</span> &lt;+<span class="hljs-number">104</span>&gt;: ldur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e60d0</span> &lt;+<span class="hljs-number">108</span>&gt;: <span class="hljs-keyword">add</span>    w8, w8, <span class="hljs-number">#0x1</span> <span class="hljs-comment">; =0x1 </span><br>    <span class="hljs-number">0x1008e60d4</span> &lt;+<span class="hljs-number">112</span>&gt;: stur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x1008e60d8</span> &lt;+<span class="hljs-number">116</span>&gt;: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x1008e60b4</span>  <span class="hljs-comment">; &lt;+80&gt; at main.m:29:12</span><br>    <span class="hljs-number">0x1008e60dc</span> &lt;+<span class="hljs-number">120</span>&gt;: ldp    x29, x30, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x10</span>]<br>    <span class="hljs-number">0x1008e60e0</span> &lt;+<span class="hljs-number">124</span>&gt;: <span class="hljs-keyword">add</span>    <span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x20</span>    <span class="hljs-comment">; =0x20 </span><br>    <span class="hljs-number">0x1008e60e4</span> &lt;+<span class="hljs-number">128</span>&gt;: ret    <br></code></pre></td></tr></table></figure><p></p><ol><li><code>cmp label1, label2</code> 实际是执行 label1 和 label2 相减的操作，其结果会影响 cpsr 寄存器，后续的 <code>b.ge</code> 和 <code>b.le</code> 根据 cpsr 寄存器的标记为决定是否跳转到指定地址执行：<ol><li><code>b.ge label</code>: 结果是大于等于时跳转到 label 执行</li><li><code>b.le label</code>: 结果是小于等于时跳转到 lebal 执行</li></ol></li><li><code>break</code> 语句编译为了一个无条件跳转指令<code>b label</code>，跳转到循环体的外面第一行指令处</li></ol><h1 id="switch-语句"><a href="#switch-语句" class="headerlink" title="switch 语句"></a>switch 语句</h1><p>从 C 的角度来看，<code>switch</code> 和 <code>if-else</code> 是可以等价变换的，但是在汇编底层角度它们有什么不同呢？</p><h2 id="case-分支小于-4-个"><a href="#case-分支小于-4-个" class="headerlink" title="case  分支小于 4 个"></a>case 分支小于 4 个</h2><p>将下面两个函数编译成汇编代码：<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">switchTest</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (a) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;3&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;4&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;7&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;miss matched&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">ifelseTest</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> &#123;<br>    <span class="hljs-keyword">if</span> (a == <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;3&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (a == <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;4&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (a == <span class="hljs-number">7</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;7&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><br><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="9d246b3e/4.png" srcset="/img/loading.gif" lazyload alt=""></div><div class="group-image-wrap"><img src="9d246b3e/5.png" srcset="/img/loading.gif" lazyload alt=""></div></div></div><p></p><p>可以看到它们几乎没有区别，都是通过 <code>cmp</code> 和 <code>b</code> 语句来控制流程走向。</p><h2 id="case-分支跨度过大"><a href="#case-分支跨度过大" class="headerlink" title="case  分支跨度过大"></a>case 分支跨度过大</h2><p>再来看看 switch case 超过 4 个，但 case 最小值和最大值超过 50 的情况：<br></p><div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="9d246b3e/6.png" srcset="/img/loading.gif" lazyload alt=""></div><div class="group-image-wrap"><img src="9d246b3e/7.png" srcset="/img/loading.gif" lazyload alt=""></div></div></div><br>汇编层面同样是通过 <code>cmp</code> 和 <code>b</code> 语句来进行控制的<p></p><h2 id="正常情况的-switch"><a href="#正常情况的-switch" class="headerlink" title="正常情况的 switch"></a>正常情况的 switch</h2><p>case 分支多于 4 个且最大值和最小值差值不超过 50 时：<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">switchTest</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> &#123;<br>    <span class="hljs-keyword">switch</span> (a) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;3&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;4&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">12</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;12&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;7&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;8&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;miss matched&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><br>形参传入 10 ，Xcode 运行后的汇编代码：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs armasm">    <span class="hljs-number">0x100b01f94</span> &lt;+<span class="hljs-number">0</span>&gt;:   <span class="hljs-keyword">sub</span>    <span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x20</span>    <span class="hljs-comment">; =0x20 </span><br>    <span class="hljs-number">0x100b01f98</span> &lt;+<span class="hljs-number">4</span>&gt;:   stp    x29, x30, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x10</span>]<br>    <span class="hljs-number">0x100b01f9c</span> &lt;+<span class="hljs-number">8</span>&gt;:   <span class="hljs-keyword">add</span>    x29, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x10</span>   <span class="hljs-comment">; =0x10 </span><br>    <span class="hljs-number">0x100b01fa0</span> &lt;+<span class="hljs-number">12</span>&gt;:  stur   w0, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x100b01fa4</span> &lt;+<span class="hljs-number">16</span>&gt;:  ldur   w8, [x29, #-<span class="hljs-number">0x4</span>]<br>    <span class="hljs-number">0x100b01fa8</span> &lt;+<span class="hljs-number">20</span>&gt;:  <span class="hljs-keyword">subs</span>   w8, w8, <span class="hljs-number">#0x2</span> <span class="hljs-comment">; =0x2 </span><br>    <span class="hljs-number">0x100b01fac</span> &lt;+<span class="hljs-number">24</span>&gt;:  <span class="hljs-keyword">mov</span>    x9, x8<br>    <span class="hljs-number">0x100b01fb0</span> &lt;+<span class="hljs-number">28</span>&gt;:  <span class="hljs-keyword">ubfx</span>   x9, x9, <span class="hljs-number">#0</span>, <span class="hljs-number">#32</span><br>-&gt;  <span class="hljs-number">0x100b01fb4</span> &lt;+<span class="hljs-number">32</span>&gt;:  <span class="hljs-keyword">cmp</span>    x9, <span class="hljs-number">#0xa</span> <span class="hljs-comment">; =0xa </span><br>    <span class="hljs-number">0x100b01fb8</span> &lt;+<span class="hljs-number">36</span>&gt;:  <span class="hljs-keyword">str</span>    x9, [<span class="hljs-built_in">sp</span>]<br>    <span class="hljs-number">0x100b01fbc</span> &lt;+<span class="hljs-number">40</span>&gt;:  b.hi   <span class="hljs-number">0x100b02028</span>  <span class="hljs-comment">; &lt;+148&gt; at main.m</span><br>    <span class="hljs-number">0x100b01fc0</span> &lt;+<span class="hljs-number">44</span>&gt;:  <span class="hljs-keyword">adrp</span>   x8, <span class="hljs-number">1</span><br>    <span class="hljs-number">0x100b01fc4</span> &lt;+<span class="hljs-number">48</span>&gt;:  <span class="hljs-keyword">add</span>    x8, x8, <span class="hljs-number">#0x40</span>    <span class="hljs-comment">; =0x40 </span><br>    <span class="hljs-number">0x100b01fc8</span> &lt;+<span class="hljs-number">52</span>&gt;:  <span class="hljs-keyword">ldr</span>    x11, [<span class="hljs-built_in">sp</span>]<br>    <span class="hljs-number">0x100b01fcc</span> &lt;+<span class="hljs-number">56</span>&gt;:  ldrsw  x10, [x8, x11, <span class="hljs-keyword">lsl</span> <span class="hljs-number">#2</span>]<br>    <span class="hljs-number">0x100b01fd0</span> &lt;+<span class="hljs-number">60</span>&gt;:  <span class="hljs-keyword">add</span>    x9, x8, x10<br>    <span class="hljs-number">0x100b01fd4</span> &lt;+<span class="hljs-number">64</span>&gt;:  <span class="hljs-keyword">br</span>     x9<br>    <span class="hljs-number">0x100b01fd8</span> &lt;+<span class="hljs-number">68</span>&gt;:  <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">1</span><br>    <span class="hljs-number">0x100b01fdc</span> &lt;+<span class="hljs-number">72</span>&gt;:  <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x662</span>   <span class="hljs-comment">; =0x662 </span><br>    <span class="hljs-number">0x100b01fe0</span> &lt;+<span class="hljs-number">76</span>&gt;:  <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100b0250c</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x100b01fe4</span> &lt;+<span class="hljs-number">80</span>&gt;:  <span class="hljs-keyword">b</span>      <span class="hljs-number">0x100b02034</span>  <span class="hljs-comment">; &lt;+160&gt; at main.m:56:1</span><br>    <span class="hljs-number">0x100b01fe8</span> &lt;+<span class="hljs-number">84</span>&gt;:  <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">1</span><br>    <span class="hljs-number">0x100b01fec</span> &lt;+<span class="hljs-number">88</span>&gt;:  <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x664</span>   <span class="hljs-comment">; =0x664 </span><br>    <span class="hljs-number">0x100b01ff0</span> &lt;+<span class="hljs-number">92</span>&gt;:  <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100b0250c</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x100b01ff4</span> &lt;+<span class="hljs-number">96</span>&gt;:  <span class="hljs-keyword">b</span>      <span class="hljs-number">0x100b02034</span>  <span class="hljs-comment">; &lt;+160&gt; at main.m:56:1</span><br>    <span class="hljs-number">0x100b01ff8</span> &lt;+<span class="hljs-number">100</span>&gt;: <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">1</span><br>    <span class="hljs-number">0x100b01ffc</span> &lt;+<span class="hljs-number">104</span>&gt;: <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x666</span>   <span class="hljs-comment">; =0x666 </span><br>    <span class="hljs-number">0x100b02000</span> &lt;+<span class="hljs-number">108</span>&gt;: <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100b0250c</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x100b02004</span> &lt;+<span class="hljs-number">112</span>&gt;: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x100b02034</span>  <span class="hljs-comment">; &lt;+160&gt; at main.m:56:1</span><br>    <span class="hljs-number">0x100b02008</span> &lt;+<span class="hljs-number">116</span>&gt;: <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">0</span><br>    <span class="hljs-number">0x100b0200c</span> &lt;+<span class="hljs-number">120</span>&gt;: <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x669</span>   <span class="hljs-comment">; =0x669 </span><br>    <span class="hljs-number">0x100b02010</span> &lt;+<span class="hljs-number">124</span>&gt;: <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100b0250c</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x100b02014</span> &lt;+<span class="hljs-number">128</span>&gt;: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x100b02034</span>  <span class="hljs-comment">; &lt;+160&gt; at main.m:56:1</span><br>    <span class="hljs-number">0x100b02018</span> &lt;+<span class="hljs-number">132</span>&gt;: <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">0</span><br>    <span class="hljs-number">0x100b0201c</span> &lt;+<span class="hljs-number">136</span>&gt;: <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x66b</span>   <span class="hljs-comment">; =0x66b </span><br>    <span class="hljs-number">0x100b02020</span> &lt;+<span class="hljs-number">140</span>&gt;: <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100b0250c</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x100b02024</span> &lt;+<span class="hljs-number">144</span>&gt;: <span class="hljs-keyword">b</span>      <span class="hljs-number">0x100b02034</span>  <span class="hljs-comment">; &lt;+160&gt; at main.m:56:1</span><br>    <span class="hljs-number">0x100b02028</span> &lt;+<span class="hljs-number">148</span>&gt;: <span class="hljs-keyword">adrp</span>   x0, <span class="hljs-number">0</span><br>    <span class="hljs-number">0x100b0202c</span> &lt;+<span class="hljs-number">152</span>&gt;: <span class="hljs-keyword">add</span>    x0, x0, <span class="hljs-number">#0x66d</span>   <span class="hljs-comment">; =0x66d </span><br>    <span class="hljs-number">0x100b02030</span> &lt;+<span class="hljs-number">156</span>&gt;: <span class="hljs-keyword">bl</span>     <span class="hljs-number">0x100b0250c</span>  <span class="hljs-comment">; symbol stub for: printf</span><br>    <span class="hljs-number">0x100b02034</span> &lt;+<span class="hljs-number">160</span>&gt;: ldp    x29, x30, [<span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x10</span>]<br>    <span class="hljs-number">0x100b02038</span> &lt;+<span class="hljs-number">164</span>&gt;: <span class="hljs-keyword">add</span>    <span class="hljs-built_in">sp</span>, <span class="hljs-built_in">sp</span>, <span class="hljs-number">#0x20</span>    <span class="hljs-comment">; =0x20 </span><br>    <span class="hljs-number">0x100b0203c</span> &lt;+<span class="hljs-number">168</span>&gt;: ret     <br></code></pre></td></tr></table></figure><p></p><ol><li>第 6-7 行表示让 w8 和 <code>0x2</code> 相减，结果存入 w8 并影响 cpsr 寄存器。w8 保存的是形参 10，与 case 最小值 2 相减，结果存入 x9。计这个差值为 D1</li><li>第 8 - 11 行，首先通过 <code>ubfx x9, x9, #0, #32</code> 清空 x9 高 32 位，只保留低 32 位的值，这里即是 D1，让 D1 与case 的最大最小差值（此处为 <code>0xa</code>，计这个差值为 D2）比较，如果最终无符号大于，表明 D1 跨越的范围大于 case 的最大最小值，说明不可能匹配成功，直接跳转到 default 分支或 switch 语句块的下一行执行，此处形参传入的是 10，在 case 最大值和最小值之间，所以会进入 switch 特有的查表跳转流程</li><li>第 12 - 17 行，先通过 page 偏移找到一个地址存入 x8，然后将之前存到栈区的只保留低 32 位的值放入 x11，后面的 <code>ldrsw x10, [x8, x11, lsl #2]</code> 表示将 x11 左移两位，再加上 x8，把结果作为地址寻址，将得到的值存入 x10，执行完毕后，x10 的值为 <code>0xffffffffffffffe8</code>，看起来像是一个负数，去掉最高位逐位取反后加 1，为 -24。x8 保存的是一个起始地址，把偏移量了 -24 后的地址放入 x9 中，接下来 <code>br</code> 语句以 x9 里面的值作为地址跳转。相比较 <code>if-else</code> ，这里只需要这一次跳转即可，无需逐个比较 case 的值</li><li>传入的 value 经过 x8 加上一个偏移量后，就可以得到真正要执行的地址。偏移量是传入的 value 决定的，那么 x8 处是什么呢？查看 <code>0x0000000100b02040</code> 处的内存数据，可以看到类似的负数有 11 个， case 最大值和最小值之差 10，再加上一个 default case 刚好就是 11。这个偏移值数组需要占用内存空间，case 分支差值跨越越大耗费的内存空间也大，编译器会决定 switch 编译后的汇编指令是查表跳转还是 <code>if-else</code> 形式的逐个 <code>cmp</code>+<code>b</code>，<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs armasm">(lldb) x/<span class="hljs-number">16</span> <span class="hljs-number">0x0000000100b02040</span><br><span class="hljs-number">0x100b02040</span>: <span class="hljs-number">0xffffff98</span> <span class="hljs-number">0xffffffe8</span> <span class="hljs-number">0xffffffa8</span> <span class="hljs-number">0xffffffe8</span><br><span class="hljs-number">0x100b02050</span>: <span class="hljs-number">0xffffffe8</span> <span class="hljs-number">0xffffffc8</span> <span class="hljs-number">0xffffffd8</span> <span class="hljs-number">0xffffffe8</span><br><span class="hljs-number">0x100b02060</span>: <span class="hljs-number">0xffffffe8</span> <span class="hljs-number">0xffffffe8</span> <span class="hljs-number">0xffffffb8</span> <span class="hljs-number">0xd10083ff</span><br><span class="hljs-number">0x100b02070</span>: <span class="hljs-number">0xa9017bfd</span> <span class="hljs-number">0x910043fd</span> <span class="hljs-number">0xb81fc3a0</span> <span class="hljs-number">0xb85fc3a8</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><ul><li>case 分支少于 4 个时，<code>switch</code> 的效率和 <code>if-else</code> 语句一样</li><li>case 分支多余 4 个且分支最大值和最小值差值合理（ arm64 时是少于等于 50 个，可能和具体的架构与编译器版本、代码优化级别有关）时，会有一个内存表来辅助计算跳转到分支的地址，得到地址后直接跳转，不在逐个比较，效率最高</li><li>case 分支最大值和最小值差值太大时，<code>switch</code> 会退化成 <code>if-else</code> 语句</li><li>对效率要求敏感的代码，可将代码结构优化成符合 <code>switch</code> 的要求，提高代码执行效率</li></ul><h1 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h1><p>Objective-C 里面少不了和各种各样的指针打交道，如果从底层汇编角度来看，指针到底代表什么呢？对指针类型做偏移操作，偏移值如何计算？</p><p>在 Objective-C 中，对象是指一块能存储数据并具有某种类型的内存空间，一个对象 a 它有值和地址 &amp;a，运行程序时，计算机会为该对象分配存储空间，存储该对象的值，我们通过该对象的地址，来访问存储空间中的值。指针 p 也是对象，它同样有地址 &amp;p 和存储的值 p，只不过，p 存储的数据类型是数据的地址。如果我们要以 p 中存储的数据为地址，来访问对象的值，则要在 p 前加解引用操作符 <code>*</code>，即 <code>*p</code>。</p><h2 id="指针偏移"><a href="#指针偏移" class="headerlink" title="指针偏移"></a>指针偏移</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> *a;<br>a = (<span class="hljs-type">int</span> *)<span class="hljs-number">100</span>;<br>a = a + <span class="hljs-number">3</span>; <br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆 指针的加减和它指向的数据的宽度有关，加上 3 个 4 字节后，a 的值为 112</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">int</span> *b;<br>b = (<span class="hljs-type">int</span> *)<span class="hljs-number">200</span>;<br><span class="hljs-type">int</span> x = b - a;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆  a 和 b 之间间隔 88 字节，转换成 int 宽度为单位后 x 的值为 22</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> p[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>&#125;;<br><span class="hljs-type">int</span> val = *p + <span class="hljs-number">3</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;val = %d&quot;</span>,val);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆 数组连续存放，p 的宽度为 4，偏移 3 个宽度后的值为 4</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h2 id="多级指针"><a href="#多级指针" class="headerlink" title="多级指针"></a>多级指针</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> **a;  <br>a = (<span class="hljs-type">int</span> **)<span class="hljs-number">100</span>;<br>a = a + <span class="hljs-number">3</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆 a 是指针类型了，宽度为 8，所以加 3 后，a 的值为 124</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">char</span> ** p1;<br>p1 = (<span class="hljs-type">char</span> **)<span class="hljs-number">100</span>;<br><span class="hljs-type">char</span> c = *(p1 + <span class="hljs-number">2</span>) + <span class="hljs-number">2</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆 p1 是 char ** 类型，是指针，宽度为 8，(p1 + 2) 后，p1 为 116。</span><br><span class="hljs-comment">*(p1 + 2) 解引用，得到指向 char 类型的指针，宽度为 1，p1 为 118。</span><br><span class="hljs-comment">这里的解引用可能会 crash，因为 p1 指向的区域并不合法</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> p1[<span class="hljs-number">4</span>][<span class="hljs-number">3</span>] = &#123;&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>&#125;,<br>    &#123;<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>&#125;,<br>    &#123;<span class="hljs-number">9</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>&#125;&#125;;<br><span class="hljs-type">int</span> **pp = p1;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆 pp 可以看做存放了三个元素的数组，数组中的每个元素是一维数组（指针）</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">int</span> *temp1 = pp + <span class="hljs-number">2</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆 pp 指向指针，宽度为 8，加 2 后相当于偏移了两个指针的宽度，</span><br><span class="hljs-comment">指向了 &#123;9,&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;&#125; 这一行首位置</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">int</span> *temp2 = *pp + <span class="hljs-number">2</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">👆 *pp 解引用后，得到指向了指针（数组）类型，加 2，相当于偏移了两个 int 宽度，</span><br><span class="hljs-comment">指向了二维数组第一行的 3</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%B1%87%E7%BC%96/">汇编</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E6%B1%87%E7%BC%96/">汇编</a> <a class="hover-with-bg" href="/tags/%E5%BA%95%E5%B1%82/">底层</a> <a class="hover-with-bg" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/befa4b6e.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">从 Git 仓库中克隆出指定 tag 处的指定文件</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/8f23431c.html"><span class="hidden-mobile">逆向学习笔记 - ARM64 汇编入门</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js",(function(){var i=Object.assign({appId:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appKey:"Y6tve5P6QYMvu13i6cXcL8ly",path:"window.location.pathname",placeholder:"说点什么",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!1,serverURLs:null,emojiCDN:null,emojiMaps:null,enableQQ:!1,appid:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appkey:"Y6tve5P6QYMvu13i6cXcL8ly"},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><span id="cnzz_stat_icon_1278975811" style="display:none"></span></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},loader:{},options:{renderActions:{findScript:[10,e=>{document.querySelectorAll('script[type^="math/tex"]').forEach(t=>{const n=!!t.type.match(/; *mode=display/),o=new e.options.MathItem(t.textContent,e.inputJax[0],n),a=document.createTextNode("");t.parentNode.replaceChild(a,t),o.start={node:a,delim:"",n:0},o.end={node:a,delim:"",n:0},e.math.push(o)})},"",!1],insertedScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(e=>{let t=e.parentNode;"li"===t.nodeName.toLowerCase()&&t.parentNode.classList.add("has-jax")})},"",!1]}}}</script><script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js"></script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?15186363";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154660540-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script defer src="//s4.cnzz.com/z_stat.php?id=1278975811&show=pic" type="text/javascript"></script><script src="/js/boot.js"></script></body></html>