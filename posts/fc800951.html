<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="Navimark"><meta name="keywords" content="load,hook,initialize"><meta name="description" content="æˆ‘ä»¬çš„ç¨‹åºç¼–è¯‘æˆäºŒè¿›åˆ¶åï¼Œåœ¨å¯åŠ¨æ—¶éœ€è¦åˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬ç±»ç¯å¢ƒçš„åˆå§‹åŒ–ï¼Œæ¶‰åŠåˆ°ç±»ç›¸å…³æ–¹æ³•çš„åŠ è½½ï¼Œå…¶ä¸­å¾ˆé‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æœ‰ +load å’Œ +initializeï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œä½†æ˜¯æ¶‰åŠåˆ°åº•å±‚ç»†èŠ‚æ—¶å¯èƒ½å°±ä¸å¤ªç†Ÿæ‚‰äº†ï¼Œæ¯”å¦‚å®ƒä»¬æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·çš„è°ƒç”¨ï¼Ÿå®ƒä»¬åœ¨å†™ä¸šåŠ¡ä»£ç æ—¶èƒ½ç”¨æ¥åšä»€ä¹ˆï¼Ÿæœ¬æ–‡å°†é€šè¿‡ runtime å’Œ dyld æºç æ¥å›ç­”è¿™äº›é—®é¢˜  å®˜"><meta property="og:type" content="article"><meta property="og:title" content="OC runtime ä¸­çš„ load å’Œ initialize"><meta property="og:url" content="https://alphabyte.tk/posts/fc800951.html"><meta property="og:site_name" content="å­éé±¼"><meta property="og:description" content="æˆ‘ä»¬çš„ç¨‹åºç¼–è¯‘æˆäºŒè¿›åˆ¶åï¼Œåœ¨å¯åŠ¨æ—¶éœ€è¦åˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬ç±»ç¯å¢ƒçš„åˆå§‹åŒ–ï¼Œæ¶‰åŠåˆ°ç±»ç›¸å…³æ–¹æ³•çš„åŠ è½½ï¼Œå…¶ä¸­å¾ˆé‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æœ‰ +load å’Œ +initializeï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œä½†æ˜¯æ¶‰åŠåˆ°åº•å±‚ç»†èŠ‚æ—¶å¯èƒ½å°±ä¸å¤ªç†Ÿæ‚‰äº†ï¼Œæ¯”å¦‚å®ƒä»¬æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·çš„è°ƒç”¨ï¼Ÿå®ƒä»¬åœ¨å†™ä¸šåŠ¡ä»£ç æ—¶èƒ½ç”¨æ¥åšä»€ä¹ˆï¼Ÿæœ¬æ–‡å°†é€šè¿‡ runtime å’Œ dyld æºç æ¥å›ç­”è¿™äº›é—®é¢˜  å®˜"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://alphabyte.tk/img/PostIndexImg/202001/load.vs.initialize.png"><meta property="article:published_time" content="2020-09-09T08:25:01.000Z"><meta property="article:modified_time" content="2022-02-23T11:00:40.430Z"><meta property="article:author" content="Navimark"><meta property="article:tag" content="åº•å±‚"><meta property="article:tag" content="iOS"><meta property="article:tag" content="Runtime"><meta property="article:tag" content="Objective-C"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://alphabyte.tk/img/PostIndexImg/202001/load.vs.initialize.png"><title>OC runtime ä¸­çš„ load å’Œ initialize - å­éé±¼</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/xcode.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"alphabyte.tk",root:"/",version:"1.8.14",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:6},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:15186363,google:"UA-154660540-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:1278975811,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body><header style="height:50vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>å­éé±¼</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="OC runtime ä¸­çš„ load å’Œ initialize"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-09-09 16:25" pubdate>2020å¹´9æœˆ9æ—¥ ä¸‹åˆ</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 10k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 88 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">OC runtime ä¸­çš„ load å’Œ initialize</h1><div class="markdown-body"><blockquote><p>æˆ‘ä»¬çš„ç¨‹åºç¼–è¯‘æˆäºŒè¿›åˆ¶åï¼Œåœ¨å¯åŠ¨æ—¶éœ€è¦åˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬ç±»ç¯å¢ƒçš„åˆå§‹åŒ–ï¼Œæ¶‰åŠåˆ°ç±»ç›¸å…³æ–¹æ³•çš„åŠ è½½ï¼Œå…¶ä¸­å¾ˆé‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æœ‰ <code>+load</code> å’Œ <code>+initialize</code>ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œä½†æ˜¯æ¶‰åŠåˆ°åº•å±‚ç»†èŠ‚æ—¶å¯èƒ½å°±ä¸å¤ªç†Ÿæ‚‰äº†ï¼Œæ¯”å¦‚å®ƒä»¬æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·çš„è°ƒç”¨ï¼Ÿå®ƒä»¬åœ¨å†™ä¸šåŠ¡ä»£ç æ—¶èƒ½ç”¨æ¥åšä»€ä¹ˆï¼Ÿæœ¬æ–‡å°†é€šè¿‡ <code>runtime</code> å’Œ <code>dyld</code> æºç æ¥å›ç­”è¿™äº›é—®é¢˜</p></blockquote><h1 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h1><p>é‡äº‹ä¸å†³ï¼Œå®˜æ–¹æ–‡æ¡£ï¼ç½‘ä¸Šçš„åšå®¢ä»¥è®¹ä¼ è®¹çš„ä¿¡æ¯å¤ªå¤šï¼Œæœ€å¯é çš„èµ„æ–™æ¥æºè¿˜æ˜¯å¾—çœ‹å®˜æ–¹æ–‡æ¡£ã€‚<br>æ ¹æ®æ–‡æ¡£ä¸Šçš„æè¿°ï¼Œ<code>+load</code> æ˜¯åœ¨ class æˆ– Category è¢«æ·»åŠ åˆ° <code>runtime</code> æ—¶è°ƒç”¨çš„ï¼Œè€Œ <code>+initialize</code> æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ”¶åˆ°æ¶ˆæ¯æ—¶è¢«è°ƒç”¨ã€‚ç»§ç»­çœ‹è¯¦æƒ…ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä»¥ä¸‹å°è±¡ï¼š</p><ul><li><code>+load</code><ul><li>é™æ€åº“æˆ–åŠ¨æ€åº“ä¸­çš„ load æ–¹æ³•éƒ½ä¼šè¢«è°ƒç”¨ï¼Œå‰ææ˜¯å®ƒä»¬å®ç°äº† load æ–¹æ³•</li><li>åœ¨ç»§æ‰¿é“¾ä¸Šä¾æ¬¡æŒ‰ç…§æœ¬ç±»ã€å­ç±»ã€å­™å­ç±»çš„é¡ºåºè°ƒç”¨</li><li>æœ¬ç±»ä¸Šçš„ load æ–¹æ³•ä¼šå…ˆäºæ‰€æœ‰åˆ†ç±»ä¸Šçš„ load æ–¹æ³•è°ƒç”¨</li></ul></li><li><code>+initialize</code><ul><li><code>+initialize</code> æ–¹æ³•ä¼šåœ¨è°ƒç”¨ç¬¬ä¸€æ¬¡è¯¥ç±»çš„æ–¹æ³•ä¹‹å‰è¢«è°ƒç”¨</li><li><code>+initialize</code> çš„è°ƒç”¨é˜»å¡å¼çš„ï¼Œåœ¨ <code>+initialize</code> æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹å‰ï¼Œè¯¥ç±»çš„å…¶ä»–ä»»ä½•æ–¹æ³•è°ƒç”¨éƒ½ä¼šè¢«é˜»æ–­ï¼ˆblockï¼‰</li><li>åœ¨ç»§æ‰¿é“¾ä¸Šä¾æ¬¡æŒ‰ç…§å­ç±»ã€å­™å­ç±»çš„é¡ºåºè°ƒç”¨</li><li>å½“ç»§æ‰¿é“¾ä¸ŠæŸä¸ªç±»æ²¡æœ‰ <code>+initialize</code> çš„å®ç°ï¼Œé‚£ä¹ˆå…¶çˆ¶ç±»çš„ <code>+initialize</code> å¯èƒ½ä¼šè¢«å¤šæ¬¡æ‰§è¡Œ</li><li><code>+initialize</code> åœ¨æ¯ä¸ªç±»ä¸Šåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡</li></ul></li></ul><h1 id="è°ƒç”¨æ—¶æœº"><a href="#è°ƒç”¨æ—¶æœº" class="headerlink" title="è°ƒç”¨æ—¶æœº"></a>è°ƒç”¨æ—¶æœº</h1><p>åŸºäº objc4-818.2 å¯è°ƒè¯•æºç <sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="https://github.com/LGCooci/objc4_debug/tree/master/objc4-818.2
">[1]</span></a></sup>åˆ›å»ºä¸€ä¸ª<a target="_blank" rel="noopener" href="https://github.com/Navimark/RuntimeLoadInit">å››ä¸–åŒå ‚å·¥ç¨‹</a>ï¼Œæ·»åŠ ç¬¦å·æ–­ç‚¹ <code>+[KFCRootObject initialize]</code> <sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="å°è¯•è¿‡åœ¨ KFCRootObject.m çš„ + (void)initialize å¤„æ·»åŠ æ–­ç‚¹ï¼Œä½†è¿è¡Œæ—¶æ²¡æœ‰è¿›æ¥ğŸ¤”ï¼ŒçŸ¥é“åŸå› çš„å¤§ä½¬çƒ¦è¯·ç•™è¨€èµæ•™
">[2]</span></a></sup>ï¼Œé€‰ä¸­Scheme: KCObjcBuildï¼Œ<code>KCObjcBuild</code> target çš„ <code>main.m</code> æ–‡ä»¶ä¸­çš„ main å‡½æ•°ä»£ç ä¸ºï¼š<br></p><figure class="highlight objc"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">int</span> main(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[]) &#123;<br>    <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>        <span class="hljs-comment">// insert code here...</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Hello, World!&quot;</span>);<br>        <span class="hljs-built_in">NSObject</span> *objc = [KFCRootObject alloc];<br>        <br>        <span class="hljs-built_in">NSObject</span> *objc1 = [KFCRootObject alloc];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><br>è¿è¡Œå<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="x86_64 æ¶æ„è¿è¡Œ
">[3]</span></a></sup>æ–¹æ³•è°ƒç”¨æ ˆï¼š<br><img src="fc800951/1.png" srcset="/img/loading.gif" lazyload alt=""><br>ä¸‹é¢æŒ‰ç…§å…¥æ ˆé¡ºåºåˆ†æ<p></p><h2 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a><code>initialize</code></h2><ol><li><p><code>main</code></p><p><img src="fc800951/3.png" srcset="/img/loading.gif" lazyload alt=""><br><code>0x0000000100008468</code> æ˜¯æŒ‡å‘ç±»å¯¹è±¡çš„æŒ‡é’ˆï¼Œè°ƒç”¨ <code>alloc</code> æ—¶ï¼Œé¦–å…ˆè¢«è½¬æ¢æˆå¯¹ <code>objc_alloc</code> çš„è°ƒç”¨</p></li><li><p><code>objc_alloc</code> -&gt; <code>callAlloc(objc_class*, bool, bool) [inlined]</code></p><p>åœ¨ <code>objc_alloc</code> å’Œ <code>callAlloc(objc_class*, bool, bool) [inlined]</code> ä¸­ï¼Œå¯¹å½¢å‚ã€è°ƒç”¨ç¯å¢ƒåšäº†ä¸€ç•ªæ ¡éªŒåï¼Œæœ€ç»ˆè°ƒç”¨äº† <code>((id(*)(id, SEL))objc_msgSend)(cls, @selector(alloc));</code>ï¼Œæ¥ç€è¿›å…¥ <code>objc_msgSend</code> çš„æ±‡ç¼–å®ç°</p></li><li><code>_objc_msgSend_uncached</code> -&gt; <code>lookUpImpOrForward</code> -&gt; <code>realizeAndInitializeIfNeeded_locked(objc_object*, objc_class*, bool)</code><ul><li>å½“ <code>@selector(alloc)</code> å¯¹åº”çš„ IMP åœ¨æ–¹æ³•ç¼“å­˜ä¸­ä¸å­˜åœ¨æ—¶ï¼Œä¼šè°ƒç”¨ <code>MethodTableLookup</code> ç»§ç»­æŸ¥æ‰¾ï¼Œè¿™éƒ¨åˆ†çš„æ±‡ç¼–ä»£ç åˆå°†æµç¨‹å¯¼å‘ <code>lookUpImpOrForward</code>ï¼Œåè€…é¢„æœŸè¿”å›è¯¥ IMPã€‚</li><li><code>lookUpImpOrForward</code> ä¸­è°ƒç”¨ <code>realizeAndInitializeIfNeeded_locked(inst, cls, behavior &amp; LOOKUP_INITIALIZE)</code> æ—¶ï¼Œ<code>behavior</code> å½¢å‚å€¼ä¸º <code>0x1011</code>ï¼ŒåŒ…å«æ ‡è®°ä½ <code>LOOKUP_INITIALIZE</code>ï¼Œå³å½¢å‚ <code>initialize</code> ä¸º true<br><img src="fc800951/4.png" srcset="/img/loading.gif" lazyload alt=""></li><li><code>(slowpath(initialize &amp;&amp; !cls-&gt;isInitialized()))</code> åˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åˆå§‹åŒ–è¿‡ï¼Œ<code>slowpath(x)</code> å®å®šä¹‰æ ‡è®°æš—ç¤ºç¼–è¯‘å™¨çš„ä¼˜åŒ–æ–¹å‘ï¼Œè¡¨æ˜ <code>x</code> è¾ƒå¤§æ¦‚ç‡ä¸º <code>false</code>ï¼Œé‡ç‚¹çœ‹çœ‹<code>!cls-&gt;isInitialized()</code>ï¼š<div class="group-image-container"><div class="group-image-row"><div class="group-image-wrap"><img src="fc800951/5.png" srcset="/img/loading.gif" lazyload alt=""></div><div class="group-image-wrap"><img src="fc800951/6.png" srcset="/img/loading.gif" lazyload alt=""></div></div></div></li><li>ä»å­—é¢æ„æ€å¯ä»¥çœ‹å‡ºå½“å‰ç±»æ˜¯å¦è¢«åˆå§‹åŒ–çš„ä¿¡æ¯ä¿å­˜åœ¨å…ƒç±»çš„ <code>class_rw_t</code> ç»“æ„çš„ <code>flags</code> æ ‡è®°ä½ä¸­ï¼Œç”±äº <code>#define RW_INITIALIZED (1&lt;&lt;29)</code>ï¼Œæ‰€ä»¥æ˜¯å¦è¢«åˆå§‹åŒ–çš„ä¿¡æ¯ä¿å­˜åœ¨ <code>flags</code> çš„å³èµ·ç¬¬ 29 ä½ä¸­</li></ul></li><li><p><code>initializeAndLeaveLocked(objc_class*, objc_object*, mutex_tt&lt;true&gt;&amp;)</code> -&gt; <code>initializeAndMaybeRelock(objc_class*, objc_object*, mutex_tt&lt;true&gt;&amp;, bool)</code> -&gt; <code>initializeNonMetaClass</code></p><p><code>initializeNonMetaClass</code> ä¸­:</p><ul><li><p>å¦‚æœå‘ç°çˆ¶ç±»æ²¡æœ‰è°ƒç”¨è¿‡åˆå§‹åŒ–æ–¹æ³•ï¼Œå°†é€’å½’è°ƒç”¨çˆ¶ç±»çš„åˆå§‹åŒ–æ–¹æ³•ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc">supercls = cls-&gt;getSuperclass();<br><span class="hljs-keyword">if</span> (supercls  &amp;&amp;  !supercls-&gt;isInitialized()) &#123;<br>    initializeNonMetaClass(supercls);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>é€šè¿‡åŠ é”æ¥è®¾ç½® <code>CLS_INITIALIZING</code></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objc">monitor_locker_t lock(classInitLock);<br><span class="hljs-keyword">if</span> (!cls-&gt;isInitialized() &amp;&amp; !cls-&gt;isInitializing()) &#123;<br>    cls-&gt;setInitializing();<br>    reallyInitialize = <span class="hljs-literal">YES</span>;<br><br>    <span class="hljs-comment">// Grab a copy of the will-initialize funcs with the lock held.</span><br>    localWillInitializeFuncs.initFrom(willInitializeFuncs);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">void</span> setInitializing() &#123;<br>    ASSERT(!isMetaClass());<br>    ISA()-&gt;setInfo(RW_INITIALIZING);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥æ ‡è®°å½“å‰ç±»è¢«å½“å‰æ‰€åœ¨çº¿ç¨‹ç‹¬å ï¼ˆå½“è¢«æŸä¸€çº¿ç¨‹ç‹¬å æ—¶ï¼Œåªèƒ½åœ¨å½“å‰çº¿ç¨‹å‘ç±»å‘é€æ¶ˆæ¯ï¼Œå…¶ä»–çº¿ç¨‹åœ¨ç‹¬å ç»“æŸä¹‹å‰åªèƒ½ç­‰å¾…ï¼‰ï¼Œç„¶åå‘å½“å‰ç±»å‘é€ <code>+initialize</code> æ¶ˆæ¯</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objc">_setThisThreadIsInitializingClass(cls);<br></code></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">void</span> callInitialize(Class cls)<br>&#123;<br>    <span class="hljs-comment">// é€šè¿‡ objc_msgSend èµ°æ¶ˆæ¯è½¬å‘æµç¨‹ã€‚</span><br>    <span class="hljs-comment">// æ„å‘³ç€å­ç±»æ²¡æœ‰å¯¹åº”çš„æ–¹æ³•å®ç°æ—¶</span><br>    <span class="hljs-comment">// ä¼šæ²¿ç€ç»§æ‰¿é“¾å»å°è¯•è°ƒç”¨çˆ¶ç±»ä¸Šçš„ initialize æ–¹æ³•</span><br>    ((<span class="hljs-keyword">void</span>(*)(Class, SEL))objc_msgSend)(cls, <span class="hljs-keyword">@selector</span>(initialize));<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>å®Œæˆåˆå§‹åŒ–ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> lockAndFinishInitializing(Class cls, Class supercls)<br>&#123;<br>    monitor_locker_t lock(classInitLock);<br>    <span class="hljs-keyword">if</span> (!supercls  ||  supercls-&gt;isInitialized()) &#123;<br>        _finishInitializing(cls, supercls);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœçˆ¶ç±»æœªè¢«åˆå§‹åŒ–ï¼Œä¼šåœ¨çˆ¶ç±»åˆå§‹åŒ–å®Œæˆåå†ä¿®æ”¹å½“å‰ cls åˆå§‹åŒ–çŠ¶æ€æ ‡è®°ä½</span><br>        _finishInitializingAfter(cls, supercls);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ•°æ®ç»“æ„ <code>PendingInitializeMap</code>:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> PendingInitialize &#123;<br>    Class subclass;<br>    <span class="hljs-keyword">struct</span> PendingInitialize *next;<br><br>    PendingInitialize(Class cls) : subclass(cls), next(nullptr) &#123; &#125;<br>&#125; PendingInitialize;<br><br><span class="hljs-keyword">typedef</span> objc::DenseMap&lt;Class, PendingInitialize *&gt; PendingInitializeMap;<br><span class="hljs-keyword">static</span> PendingInitializeMap *pendingInitializeMap;<br></code></pre></td></tr></table></figure><p><code>pendingInitializeMap</code> æ˜¯ä¸€ä¸ªå…¨å±€çš„å­—å…¸ç»“æ„ï¼Œå®ƒè´Ÿè´£ç»´æŠ¤ <code>+initialize</code> è°ƒç”¨çš„ä¾èµ–ï¼Œä¼šåœ¨ä¸¤ä¸ªåœ°æ–¹è®¿é—®ï¼š</p><ol><li><p>çˆ¶ç±»æœªå®Œæˆåˆå§‹åŒ–æ—¶ã€‚çˆ¶ç±»çš„åˆå§‹åŒ–ä¼šä¼˜å…ˆäºå½“å‰ç±»ï¼Œè¿™ä¸€è®¾å®šæ˜¯é€šè¿‡ <code>_finishInitializingAfter</code> ä¸­å¦‚ä¸‹çš„å…³é”®ä»£ç ä¿è¯çš„ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objc">PendingInitialize *pending = new PendingInitialize&#123;cls&#125;;<br>auto result = pendingInitializeMap-&gt;try_emplace(supercls, \<br>pending);<br><span class="hljs-keyword">if</span> (!result.second) &#123;<br>    pending-&gt;next = result.first-&gt;second;<br>    result.first-&gt;second = pending;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>çˆ¶ç±»å·²ç»åˆå§‹åŒ–å®Œæˆæ—¶ï¼Œè°ƒç”¨ <code>_finishInitializing</code>ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _finishInitializing(Class cls, Class supercls)<br>&#123;<br>    PendingInitialize *pending;<br><br>    classInitLock.assertLocked();<br>    ASSERT(!supercls  ||  supercls-&gt;isInitialized());<br><br>    <span class="hljs-keyword">if</span> (PrintInitializing) &#123;<br>        _objc_inform(<span class="hljs-string">&quot;INITIALIZE: thread %p: %s is \</span><br><span class="hljs-string">                    fully +initialized&quot;</span>,<br>                    objc_thread_self(), cls-&gt;nameForLogging());<br>    &#125;<br><br>    <span class="hljs-comment">// mark this class as fully +initialized</span><br>    cls-&gt;setInitialized();<br>    classInitLock.notifyAll();<br>    _setThisThreadIsNotInitializingClass(cls);<br>    <br>    <span class="hljs-keyword">if</span> (!pendingInitializeMap) <span class="hljs-keyword">return</span>;<br><br>    auto it = pendingInitializeMap-&gt;find(cls);<br>    <span class="hljs-keyword">if</span> (it == pendingInitializeMap-&gt;end()) <span class="hljs-keyword">return</span>;<br><br>    pending = it-&gt;second;<br>    pendingInitializeMap-&gt;erase(it);<br><br>    <span class="hljs-keyword">if</span> (pendingInitializeMap-&gt;size() == <span class="hljs-number">0</span>) &#123;<br>        delete pendingInitializeMap;<br>        pendingInitializeMap = <span class="hljs-literal">nil</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (pending) &#123;<br>        PendingInitialize *next = pending-&gt;next;<br>        <span class="hljs-keyword">if</span> (pending-&gt;subclass) <br>            _finishInitializing(pending-&gt;subclass, cls);<br>        delete pending;<br>        pending = next;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>_finishInitializing</code> å‡½æ•°ä¸­ï¼Œè®¾ç½® <code>RW_INITIALIZED</code> æ ‡è®°å¹¶æ¸…é™¤ä¹‹å‰è®¾ç½®çš„ <code>RW_INITIALIZING</code>ï¼Œè®¾ç½®å½“å‰ç±»ä¸å†è¢«å½“å‰çº¿ç¨‹ç‹¬å ï¼Œç„¶åé€’å½’åœ°å°†å…ˆå‰è¢«é˜»å¡çš„å­ç±»è®¾ç½®ä¸ºåˆå§‹åŒ–å®ŒæˆçŠ¶æ€ï¼Œç”±äºåˆå§‹åŒ–å·¥ä½œå·²å®Œæˆï¼Œè¿™é‡Œè¿˜æ¸…ç†äº†ä¸å†éœ€è¦çš„å†…å­˜å ç”¨</p></li></ol></li><li><p>åœ¨ç±»åˆå§‹åŒ–æœªå®Œæˆä¹‹å‰ï¼ˆ<code>RW_INITIALIZING</code>ï¼‰ï¼Œåç»­åœ¨è¯¥çº¿ç¨‹ä¸Šå…¶ä»–çš„ <code>+initialize</code> è°ƒç”¨éƒ½ä¼šè¢«ç›´æ¥ <code>return</code>ï¼›åœ¨ç±»å·²ç»å®Œæˆåˆå§‹åŒ–æ—¶ï¼ˆ<code>RW_INITIALIZED</code>ï¼‰ç›´æ¥ <code>return</code>ï¼Œå®˜æ–¹çš„æ³¨é‡Šä¹Ÿå¾ˆè¯¦ç»†ï¼š</p><details><summary>æŸ¥çœ‹å®˜æ–¹æ³¨é‡Š</summary><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">if</span> (...) &#123;...&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cls-&gt;isInitializing()) &#123;<br>    <span class="hljs-comment">// We couldn&#x27;t set INITIALIZING because INITIALIZING was already set.</span><br>    <span class="hljs-comment">// If this thread set it earlier, continue normally.</span><br>    <span class="hljs-comment">// If some other thread set it, block until initialize is done.</span><br>    <span class="hljs-comment">// It&#x27;s ok if INITIALIZING changes to INITIALIZED while we&#x27;re here, </span><br>    <span class="hljs-comment">//   because we safely check for INITIALIZED inside the lock </span><br>    <span class="hljs-comment">//   before blocking.</span><br>    <span class="hljs-keyword">if</span> (_thisThreadIsInitializingClass(cls)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!MultithreadedForkChild) &#123;<br>        waitForInitializeToComplete(cls);<br>        <span class="hljs-keyword">return</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// We&#x27;re on the child side of fork(), facing a class that</span><br>        <span class="hljs-comment">// was initializing by some other thread when fork() was called.</span><br>        _setThisThreadIsInitializingClass(cls);<br>        performForkChildInitialize(cls, supercls);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cls-&gt;isInitialized()) &#123;<br>    <span class="hljs-comment">// Set CLS_INITIALIZING failed because someone else already </span><br>    <span class="hljs-comment">//   initialized the class. Continue normally.</span><br>    <span class="hljs-comment">// NOTE this check must come AFTER the ISINITIALIZING case.</span><br>    <span class="hljs-comment">// Otherwise: Another thread is initializing this class. ISINITIALIZED </span><br>    <span class="hljs-comment">//   is false. Skip this clause. Then the other thread finishes </span><br>    <span class="hljs-comment">//   initialization and sets INITIALIZING=no and INITIALIZED=yes. </span><br>    <span class="hljs-comment">//   Skip the ISINITIALIZING clause. Die horribly.</span><br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure></details></li></ul></li><li>åˆ°è¿™é‡Œå·²ç»æ¢³ç†å®Œäº†ç±»çš„ <code>+initialize</code> è°ƒç”¨æµç¨‹ï¼ŒéªŒè¯äº†è‹¹æœ API æ–‡æ¡£ä¸­å…³äº <code>+initialize</code> çš„ç‰¹æ€§</li></ol><h2 id="load"><a href="#load" class="headerlink" title="load"></a><code>load</code></h2><blockquote><p><code>load</code> æ–¹æ³•ç›¸ä¿¡éƒ½ä¸é™Œç”Ÿï¼Œç”¨å¾—æœ€å¤šçš„åœºæ™¯å°±æ˜¯æ–¹æ³•äº¤æ¢ï¼Œè€Œä¸”å¤§å®¶ä¹Ÿéƒ½çŸ¥é“ <code>load</code> æ–¹æ³•ä¼šå…ˆäº <code>main</code> å‡½æ•°è°ƒç”¨ã€‚æ¥ä¸‹æ¥å°†å¯¹ç…§æºç æ¥ç†è§£ <code>load</code> æ–¹æ³•å…·ä½“çš„è°ƒç”¨è¿‡ç¨‹ã€‚</p></blockquote><p>è¿˜æ˜¯åˆšåˆšçš„<a target="_blank" rel="noopener" href="https://github.com/Navimark/RuntimeLoadInit">å››ä¸–åŒå ‚å·¥ç¨‹</a>ï¼Œæ·»åŠ ç¬¦å·æ–­ç‚¹ <code>+[KFCRootObject load]</code>ï¼Œè¿è¡Œåçš„è°ƒç”¨æ ˆä¸ºï¼š<br><img src="fc800951/7.png" srcset="/img/loading.gif" lazyload alt=""><br>è¿˜æ˜¯æŒ‰ç…§å…¥æ ˆé¡ºåºåˆ†æï¼š</p><ol><li><p><code>_dyld_start</code>-&gt;<code>dyld::notifySingle(dyld_image_states, ImageLoader const*, ImageLoader::InitializerTimingList*)</code> -&gt; <code>load_images</code>ï¼Œå‰ä¸¤ä¸ªæ ˆè®°å½•æ˜¯æ“ä½œç³»ç»Ÿé€šè¿‡ <code>dyld</code> åŠ è½½ç¨‹åºæ—¶ï¼Œ<code>dyld</code> çš„å†…éƒ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œ<code>dyld</code> è´Ÿè´£ç»™ç¨‹åºåˆ›å»ºä¸€ä¸ªå’Œæ“ä½œç³»ç»Ÿç»‘å®šçš„è¿è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬é“¾æ¥ç¨‹åºæ‰€ç”¨åˆ°çš„åŠ¨æ€åº“ï¼ˆåŒ…æ‹¬ç³»ç»ŸåŠ¨æ€åº“ï¼‰ã€ç»‘å®šå¤–éƒ¨è°ƒç”¨ç¬¦å·ã€rebase åŸºå€ï¼Œåšå®Œäº†ç¯å¢ƒå‡†å¤‡å·¥ä½œåï¼Œé€šè¿‡ <code>load_images</code> å›è°ƒ runtimeã€‚æˆ‘ä»¬å¢åŠ ä¸€ä¸ªç¬¦å·æ–­ç‚¹ï¼š<code>load_images</code>ï¼Œé‡æ–° run èµ·æ¥ï¼š<br><img src="fc800951/8.png" srcset="/img/loading.gif" lazyload alt=""></p><p>å®šä½åˆ° <code>_objc_init</code> çš„æºç ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">void</span> _objc_init(<span class="hljs-keyword">void</span>)<br>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> initialized = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (initialized) <span class="hljs-keyword">return</span>;<br>    initialized = <span class="hljs-literal">true</span>;<br>    <br>    <span class="hljs-comment">// fixme defer initialization until an objc-using image is found?</span><br>    environ_init();<br>    tls_init();<br>    static_init();<br>    runtime_init();<br>    exception_init();<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> __OBJC2__</span><br>    cache_t::init();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    _imp_implementationWithBlock_init();<br><br>    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> __OBJC2__</span><br>    didCallDyldNotifyRegister = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>é“¾æ¥åº“è¢«åˆå§‹åŒ–ä¹‹å‰ <code>libSystem</code> è°ƒç”¨ <code>_objc_init</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨ <code>_objc_init</code> ä¸­åˆé€šè¿‡ <code>_dyld_objc_notify_register</code> æ³¨å†Œäº† <code>dyld</code> çš„å›è°ƒï¼Œåœ¨ <code>dyld</code> <a target="_blank" rel="noopener" href="https://opensource.apple.com/source/dyld/dyld-832.7.1/include/mach-o/dyld_priv.h.auto.html">æºç </a><sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ dyld æºç ï¼šè¾“å…¥ lldb å‘½ä»¤ï¼šimage list dyldï¼Œå¾—åˆ°dyldæ‰€åœ¨è·¯å¾„ä¸ºï¼š/usr/lib/dyldï¼Œä½¿ç”¨ MachOView æ‰“å¼€ï¼Œåœ¨ LoadCommand çš„ LC_SOURCE_VERSION ä¸­æ‰¾åˆ°æºç  Version ï¼Œæˆ‘è¿™é‡Œæ˜¯ 832.7.1
">[4]</span></a></sup> ä¸­å¯ä»¥æŸ¥çœ‹åˆ° <code>_dyld_objc_notify_register</code> çš„åŸå‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">void</span> _dyld_objc_notify_register(_dyld_objc_notify_mapped    mapped,<br>                                _dyld_objc_notify_init      init,<br>                                _dyld_objc_notify_unmapped  unmapped);<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå¯çŸ¥ï¼Œå½“æŸä¸ªé•œåƒå°†è¢« <code>dyld</code> åˆå§‹åŒ–æ—¶ï¼Œ<code>dyld</code> ä¼šé€šè¿‡ <code>init</code> è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå½¢å‚å°†è¯¥é•œåƒä¿¡æ¯å›è°ƒç»™ objc runtimeã€‚æ¥çœ‹çœ‹ <code>load_images</code>:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objc"><span class="hljs-keyword">void</span> load_images(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path __unused, <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> mach_header *mh)<br>&#123;<br>    <span class="hljs-keyword">if</span> (!didInitialAttachCategories &amp;&amp; didCallDyldNotifyRegister) &#123;<br>        didInitialAttachCategories = <span class="hljs-literal">true</span>;<br>        loadAllCategories();<br>    &#125;<br><br>    <span class="hljs-comment">// Return without taking locks if there are no +load methods here.</span><br>    <span class="hljs-keyword">if</span> (!hasLoadMethods((<span class="hljs-keyword">const</span> headerType *)mh)) <span class="hljs-keyword">return</span>;<br><br>    recursive_mutex_locker_t lock(loadMethodLock);<br><br>    <span class="hljs-comment">// Discover load methods</span><br>    &#123;<br>        mutex_locker_t lock2(runtimeLock);<br>        prepare_load_methods((<span class="hljs-keyword">const</span> headerType *)mh);<br>    &#125;<br><br>    <span class="hljs-comment">// Call +load methods (without runtimeLock - re-entrant)</span><br>    call_load_methods();<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>éå†æ‰€æœ‰é“¾æ¥è¿›æ¥çš„ Image å¤´ä¿¡æ¯é“¾è¡¨ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„ Category æ–¹æ³•ï¼Œå¹¶é™„åŠ åˆ°å¯¹åº”çš„ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸Š</li><li>é€šè¿‡æŸ¥è¯¢ Image çš„ Mach-O ç»“æ„ï¼Œåœ¨ <code>__DATA,__objc_nlclslist</code> å’Œ <code>__DATA,__objc_nlcatlist</code> ä¸­åˆ†åˆ«æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒ…å« <code>+load</code> æ–¹æ³•çš„ç±»å’ŒåŒ…å« <code>+load</code> æ–¹æ³•çš„åˆ†ç±»ï¼Œ å¦‚æœæ²¡æœ‰ï¼Œè·³è¿‡ <code>load_images</code> æ¥ä¸‹æ¥çš„æ­¥éª¤</li><li>å‡†å¤‡ load æ–¹æ³•ã€‚å…ˆé€šè¿‡ <code>_getObjc2NonlazyClassList</code> è·å–åˆ°æ‰€æœ‰åŒ…å« <code>+load</code> çš„ç±»ï¼ˆè¯è¯´è¿™é‡Œåˆ†åˆ«è¿›è¡Œäº†ä¸¤æ¬¡é‡å¤çš„ Mach-O ç»“æ„çš„æŸ¥æ‰¾ï¼Œä¹Ÿè®¸å¯ä»¥åˆå¹¶ä¸ºä¸€æ¬¡ğŸ¤”ï¼‰ï¼Œç„¶åå°†è¿™äº›ç±»æ·»åŠ åˆ° <code>loadable_classes</code> æ•°ç»„ä¸­ã€‚å¦‚æœæŸä¸ªç±»æœ‰çˆ¶ç±»ï¼Œçˆ¶ç±»çš„ load æ–¹æ³•ï¼ˆå¦‚æœæœ‰ï¼‰å°†ä¼šå…ˆæ·»åŠ åˆ° <code>loadable_classes</code> é‡Œé¢ï¼Œè¿™æ˜¯é€šè¿‡ <code>schedule_class_load</code> çš„é€’å½’è°ƒç”¨ä¿è¯çš„ã€‚æ¥ä¸‹æ¥å¯¹åŒ…å« <code>+load</code> çš„åˆ†ç±»è¿›è¡Œç±»ä¼¼çš„æ“ä½œï¼Œå°†ç»“æœä¿å­˜åœ¨ <code>loadable_categories</code> æ•°ç»„ä¸­ã€‚</li><li>è°ƒç”¨ <code>call_load_methods</code>ï¼Œæ‰§è¡Œ +load æ–¹æ³•ã€‚<code>call_load_methods</code> å¯èƒ½ä¼šè§¦å‘å…¶ä»–é•œåƒçš„æ˜ å°„(mapping)ï¼Œå…¶ä»–çš„é•œåƒæ˜ å°„æ—¶å¯èƒ½ä¼šæœ‰å®ƒè‡ªå·±çš„ <code>+load</code> è°ƒç”¨è¿‡ç¨‹ï¼Œæ‰€ä»¥ <code>call_load_methods</code> å¯èƒ½ä¼šå‘ç”Ÿ Re-entrantã€‚å½“ Re-entrant å‘ç”Ÿæ—¶å•¥ä¹Ÿä¸ç”¨åšï¼Œå› ä¸ºæŒ‰ç…§æˆ‘ä»¬åˆšåˆšçš„åˆ†æï¼Œå…¶ä»–é•œåƒåŠ è½½æ—¶æ‰§è¡Œåˆ° <code>call_load_methods</code> æ—¶ï¼Œæ‰€åŒ…å« <code>+load</code> æ–¹æ³•çš„ç±»å’Œåˆ†ç±»å·²ç»è¢«æ·»åŠ åˆ°äº†å…¨å±€çš„ <code>loadable_classes</code> å’Œ <code>loadable_categories</code> ä¸­ã€‚</li><li>å…ˆå¼€å¯ä¸€ä¸ª <code>autoreleasepool</code>ï¼Œæ¥ä¸‹æ¥ä¼šå…ˆåœ¨ä¸€ä¸ªå¾ªç¯ä¸­ä¸æ–­è°ƒç”¨å…ˆå‰æ‰¾åˆ°çš„ç±»çš„ <code>+load</code> æ–¹æ³•ï¼Œä¸”ä¿è¯åœ¨ä¸€ä¸ªé•œåƒä¸­ï¼Œæœ¬ç±»çš„ <code>+load</code> æ€»æ˜¯æ¯”åˆ†ç±»çš„ <code>+load</code> å…ˆè°ƒç”¨</li><li><code>call_class_loads</code> æ–¹æ³•ï¼Œæ¶‰åŠåˆ°ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„ä»»åŠ¡æ§åˆ¶ã€‚å…ˆå‰æˆ‘ä»¬çŸ¥é“ <code>loadable_classes</code> æ•°ç»„ä¿å­˜çš„æ˜¯ <code>struct loadable_class</code> ç»“æ„ä½“ï¼Œå®ƒæŒ‡å‘é€šè¿‡ <code>realloc</code> ç”³è¯·åˆ°çš„å†…å­˜ï¼Œåœ¨ <code>call_class_loads</code> ä¸­é¦–å…ˆç”¨ä¸€ä¸ªä¸´æ—¶æŒ‡é’ˆæŒ‡å‘è¯¥å†…å­˜åŒºé—´ï¼Œç„¶åé‡ç½® <code>loadable_classes</code> ç›¸å…³çš„å…¨å±€å˜é‡ï¼Œåç»­å¦‚æœå…¶ä»–çš„ Image è¢«åŠ è½½å¯¼è‡´ <code>add_class_to_loadable_list</code> è¢«è°ƒç”¨æ—¶ <code>loadable_classes</code> æ•°ç»„ä¼šæŒ‡å‘é‡æ–°ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼Œ<code>+load</code> æ–¹æ³•ä¼šè¢«ç»§ç»­æ·»åŠ åˆ°è¿™ä¸ªæ•°ç»„é‡Œé¢ï¼Œè§† <code>call_class_loads</code> æ¶ˆè€—çš„é€Ÿåº¦ï¼Œ<code>loadable_classes</code> å¯èƒ½æ˜¯é‡æ–°ç”³è¯·å†…å­˜(<code>loadable_classes == NULL</code> æ—¶)ï¼Œä¹Ÿå¯èƒ½æ˜¯åœ¨åŸæœ‰å†…å­˜åŒºåŸŸæ‰©å¤§ç©ºé—´ï¼Œè¿™äº›å †ç©ºé—´æœ€ç»ˆéƒ½ä¼šåœ¨ <code>call_class_loads</code> ä¸­è¢« <code>free</code>ã€‚å›åˆ° <code>call_class_loads</code> å‡½æ•°ï¼Œå®ƒé¡ºåºéå†ä¸Šè¿°ä¸´æ—¶æŒ‡é’ˆæŒ‡å‘çš„æ•°ç»„ï¼Œå–å‡º <code>load_method_t</code> è¿›è¡Œ <code>+load</code> è°ƒç”¨ï¼ˆæ³¨æ„æ˜¯é€šè¿‡å‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰èµ° <code>objc_msgSend</code> æµç¨‹ï¼‰ï¼Œç”±äºè¯¥æ•°ç»„ä¸­çˆ¶ç±»çš„ <code>+load</code> åœ¨å‰é¢ï¼Œæ‰€ä»¥çˆ¶ç±»çš„ <code>+load</code> æ–¹æ³•ä¼šè¢«å…ˆè°ƒç”¨</li><li>å¯¹åˆ†ç±»çš„ <code>+load</code> æ–¹æ³•æ”¶é›†å’Œæœ¬ç±»çš„å·®ä¸å¤šï¼Œä½†æ˜¯å½“åˆ†ç±»çš„ Image åœ¨æœ¬ç±»çš„ Image ä¹‹å‰è¢«åŠ è½½è¿è¡Œæ—¶ï¼Œå­˜åœ¨é¢å¤–çš„å¤„ç†æµç¨‹ï¼Œæ‰€ä»¥åˆ†ç±»çš„ <code>+load</code> è°ƒç”¨é€»è¾‘ä¼šæœ‰æ‰€ä¸åŒã€‚å…ˆéå†<code>loadable_categories</code>ï¼Œå¦‚æœç±»è¢«é¦–æ¬¡åŠ è½½è¿‡ï¼ˆRealizedï¼‰å°±è°ƒç”¨å…¶ <code>+load</code> æ–¹æ³•ï¼Œç„¶åå°†è¯¥åˆ†ç±»çš„ä»æ•°ç»„ä¸­ç§»é™¤ï¼ŒåŒæ—¶ä¼šå°† Re-entrant è¿‡ç¨‹æ–°å¢åŠ çš„åˆ†ç±»æ•´ç†åˆ°ä¸€èµ·ï¼Œæœ€åå¦‚æœ <code>loadable_categories_used</code> ä¸ä¸º 0ï¼Œè¿”å› <code>true</code>ï¼Œä»¥ä¾¿åœ¨ <code>call_load_methods</code> ä¸­èƒ½å¤Ÿé€šè¿‡å¾ªç¯ç»§ç»­å¤„ç†æœ¬æ¬¡æœªå¤„ç†å®Œæ¯•çš„åˆ†ç±» <code>+load</code> æ–¹æ³•</li></ol></li></ol><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æˆ‘ä»¬é€šè¿‡æºç åˆ†æ <code>+load</code> å’Œ <code>+initialize</code> çš„è°ƒç”¨æ—¶æœºä»¥åŠå®ƒä»¬å„è‡ªçš„è°ƒç”¨ç‰¹ç‚¹ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li><p><code>+load</code></p><ol><li>ç±»çš„ <code>+load</code> æ–¹æ³•ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè€Œä¸”æ˜¯åœ¨ <code>+main</code> å‡½æ•°ä¹‹å‰è¢«è°ƒç”¨</li><li>çˆ¶ç±»çš„ <code>+load</code> æ–¹æ³•ä¸€å®šä¼šå…ˆäºå­ç±»çš„ <code>+load</code> æ–¹æ³•è°ƒç”¨ï¼Œè€Œä¸”åœ¨å­ç±»çš„ <code>+load</code> ä¸­ä¸éœ€è¦æ·»åŠ  <code>[super load];</code></li><li>ç±»çš„ <code>+load</code> æ–¹æ³•ä¼šå…ˆäºåˆ†ç±»çš„ <code>+load</code> æ–¹æ³•è°ƒç”¨</li><li>ç”±äºåŠ¨æ€é“¾æ¥åº“å…ˆäºä¸»ç¨‹åºäºŒè¿›åˆ¶åŠ è½½ï¼Œæ‰€ä»¥åŠ¨æ€é“¾æ¥åº“é‡Œé¢çš„ <code>+load</code> æ–¹æ³•ä¼šå…ˆäºä¸»ç¨‹åºçš„ <code>+load</code> æ–¹æ³•è°ƒç”¨</li></ol></li><li><code>+initialize</code><ol><li><code>+initialize</code> ä¼šåœ¨ç±»é¦–æ¬¡æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰è°ƒç”¨</li><li>çˆ¶ç±»çš„ <code>+initialize</code> ä¼šä¼˜å…ˆäºå­ç±»çš„ <code>+initialize</code> è°ƒç”¨</li><li>runtime ä¼šè‡ªåŠ¨å¤„ç†å¯¹ç»§æ‰¿é“¾ä¸Šçš„ <code>+initialize</code> è°ƒç”¨ï¼Œæ‰€ä»¥é‡å†™æ—¶æ— éœ€è°ƒç”¨ <code>[super initialize];</code></li><li>ç›¸å¯¹äº <code>+load</code> ï¼Œ<code>+initialize</code> æ˜¯æ™®é€šæ–¹æ³•ï¼Œå¯ä»¥è¢«äº¤æ¢ï¼›åœ¨å¤šä¸ªåˆ†ç±»ä¸­è¢«å®ç°æ—¶åªä¼šè°ƒç”¨ Complie Sources åˆ—è¡¨ä¸­æœ€é åçš„åˆ†ç±»ä¸­çš„é‚£ä¸ª</li></ol></li></ul><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://github.com/LGCooci/objc4_debug/tree/master/objc4-818.2">https://github.com/LGCooci/objc4_debug/tree/master/objc4-818.2</a> <a href="#fnref:1" rev="footnote" class="footnote-backref">â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>å°è¯•è¿‡åœ¨ <code>KFCRootObject.m</code> çš„ <code>+ (void)initialize</code> å¤„æ·»åŠ æ–­ç‚¹ï¼Œä½†è¿è¡Œæ—¶æ²¡æœ‰è¿›æ¥ğŸ¤”ï¼ŒçŸ¥é“åŸå› çš„å¤§ä½¬çƒ¦è¯·ç•™è¨€èµæ•™ <a href="#fnref:2" rev="footnote" class="footnote-backref">â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span>x86_64 æ¶æ„è¿è¡Œ <a href="#fnref:3" rev="footnote" class="footnote-backref">â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span>æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ <code>dyld</code> æºç ï¼šè¾“å…¥ <code>lldb</code> å‘½ä»¤ï¼š<code>image list dyld</code>ï¼Œå¾—åˆ°<code>dyld</code>æ‰€åœ¨è·¯å¾„ä¸ºï¼š<code>/usr/lib/dyld</code>ï¼Œä½¿ç”¨ MachOView æ‰“å¼€ï¼Œåœ¨ LoadCommand çš„ LC_SOURCE_VERSION ä¸­æ‰¾åˆ°æºç  Version ï¼Œæˆ‘è¿™é‡Œæ˜¯ <code>832.7.1</code> <a href="#fnref:4" rev="footnote" class="footnote-backref">â†©</a></span></span></li></ol></div></section></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E5%BA%95%E5%B1%82/">åº•å±‚</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E5%BA%95%E5%B1%82/">åº•å±‚</a> <a class="hover-with-bg" href="/tags/iOS/">iOS</a> <a class="hover-with-bg" href="/tags/Runtime/">Runtime</a> <a class="hover-with-bg" href="/tags/Objective-C/">Objective-C</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/d463489f.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">ä½¿ç”¨ Xcode ç¼–è¯‘è§„åˆ™æå‡ä»£ç è´¨é‡</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/posts/4b4dbb8b.html"><span class="hidden-mobile">ç»™ Xcode å·¥ç¨‹çš„ AppIcon æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js",(function(){var i=Object.assign({appId:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appKey:"Y6tve5P6QYMvu13i6cXcL8ly",path:"window.location.pathname",placeholder:"è¯´ç‚¹ä»€ä¹ˆ",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!1,serverURLs:null,emojiCDN:null,emojiMaps:null,enableQQ:!1,appid:"wphA3YWunUyu9a9gbGyb9kh1-MdYXbMMI",appkey:"Y6tve5P6QYMvu13i6cXcL8ly"},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><span id="cnzz_stat_icon_1278975811" style="display:none"></span></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?15186363";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154660540-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script defer src="//s4.cnzz.com/z_stat.php?id=1278975811&show=pic" type="text/javascript"></script><script src="/js/boot.js"></script></body></html>